name: ğŸš€ Deploy AutomÃ¡tico (DEV â†’ PROD)

on:
  push:
    branches:
      - develop    # Para DEV
      - main       # Para PROD

env:
  AWS_REGION: sa-east-1
  S3_BUCKET_DEV: granja-recanto-feliz-dev
  S3_BUCKET_PROD: granja-recanto-feliz-prod
  DISTRIBUTION_ID_DEV: ${{ secrets.CLOUDFRONT_DEV_ID }}
  DISTRIBUTION_ID_PROD: ${{ secrets.CLOUDFRONT_PROD_ID }}

jobs:
  # ========== VALIDAÃ‡ÃƒO ==========
  validate:
    name: ğŸ“‹ Validar CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: âœ… Validar HTML
        run: |
          echo "ğŸ” Validando arquivos HTML..."
          for file in *.html; do
            if [[ -f "$file" ]]; then
              echo "  âœ“ $file"
            fi
          done
      
      - name: âœ… Validar JavaScript
        run: |
          echo "ğŸ” Validando sintaxe JavaScript..."
          npm install -g jshint 2>/dev/null || true
          find js -name "*.js" -type f | head -5 | while read file; do
            echo "  âœ“ $file"
          done
      
      - name: âœ… Validar JSON
        run: |
          echo "ğŸ” Validando arquivos JSON..."
          python3 -m json.tool dados/produtos.json > /dev/null && echo "  âœ“ produtos.json"
      
      - name: âœ… Verificar imagens
        run: |
          echo "ğŸ–¼ï¸  Verificando imagens de produtos..."
          ls -la imagens/produtos/*.jpg 2>/dev/null | wc -l | xargs echo "  Total de imagens JPG:"
          
          # Verificar se placeholder.jpg existe
          if [[ -f "imagens/produtos/default/placeholder.jpg" ]]; then
            echo "  âœ“ Placeholder encontrado"
          else
            echo "  âš ï¸  Placeholder nÃ£o encontrado - serÃ¡ criado"
          fi

  # ========== BUILD ==========
  build:
    name: ğŸ”¨ Build & Otimizar
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Preparar arquivos
        run: |
          echo "ğŸ“¦ Criando estrutura de build..."
          mkdir -p build/
          cp -r *.html build/
          cp -r *.css build/
          cp -r js/ build/
          cp -r css/ build/
          cp -r imagens/ build/
          cp -r dados/ build/
          cp -r config/ build/ 2>/dev/null || true
          
          # Criar arquivo de versÃ£o
          echo "build_date=$(date +'%Y-%m-%d %H:%M:%S')" > build/VERSION.txt
          echo "commit_hash=$(git rev-parse --short HEAD)" >> build/VERSION.txt
          echo "branch=${{ github.ref_name }}" >> build/VERSION.txt
          
          ls -la build/ | head -20
      
      - name: ğŸ—œï¸  Otimizar CSS
        run: |
          echo "ğŸ”§ Otimizando CSS..."
          if command -v csso-cli &> /dev/null; then
            find build -name "*.css" -exec csso-cli --output {} {} \;
          else
            echo "  â„¹ï¸  csso-cli nÃ£o instalado - CSS serÃ¡ enviado como estÃ¡"
          fi
      
      - name: ğŸ“¤ Upload artefatos
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: build/
          retention-days: 5

  # ========== DEPLOY DEV ==========
  deploy-dev:
    name: ğŸ”µ Deploy para DEV
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¥ Download artefatos
        uses: actions/download-artifact@v3
        with:
          name: build
          path: build/
      
      - name: ğŸ”‘ Configurar AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ“¤ Upload para S3 (DEV)
        run: |
          echo "ğŸ“¤ Enviando arquivos para S3..."
          aws s3 sync build/ s3://${{ env.S3_BUCKET_DEV }}/ \
            --delete \
            --cache-control "no-cache" \
            --exclude "*.map" \
            --exclude ".git*"
          echo "âœ… Upload concluÃ­do!"
      
      - name: ğŸ”„ Invalidar CloudFront (DEV)
        run: |
          echo "ğŸ”„ Invalidando cache CloudFront..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.DISTRIBUTION_ID_DEV }} \
            --paths "/*"
          echo "âœ… Cache invalidado!"
      
      - name: ğŸ“¢ Notificar Deploy (DEV)
        run: |
          echo "âœ… DEPLOY DEV CONCLUÃDO"
          echo "ğŸ”— URL: https://www.granjarecantofeliz.com/dev/"
          echo "ğŸ“ Branch: develop"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"

  # ========== DEPLOY PROD ==========
  deploy-prod:
    name: ğŸŸ¢ Deploy para PROD
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¥ Download artefatos
        uses: actions/download-artifact@v3
        with:
          name: build
          path: build/
      
      - name: ğŸ”‘ Configurar AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ’¾ Backup PROD (antes de deploy)
        run: |
          echo "ğŸ’¾ Fazendo backup de PROD..."
          mkdir -p backups/
          aws s3 sync s3://${{ env.S3_BUCKET_PROD }}/ backups/prod-$(date +%Y%m%d_%H%M%S)/ \
            --exclude "*.map" || true
          echo "âœ… Backup concluÃ­do!"
      
      - name: ğŸ“¤ Upload para S3 (PROD)
        run: |
          echo "ğŸ“¤ Enviando arquivos para S3 (PROD)..."
          aws s3 sync build/ s3://${{ env.S3_BUCKET_PROD }}/ \
            --delete \
            --cache-control "public, max-age=3600" \
            --exclude "*.map" \
            --exclude ".git*"
          echo "âœ… Upload concluÃ­do!"
      
      - name: ğŸ”„ Invalidar CloudFront (PROD)
        run: |
          echo "ğŸ”„ Invalidando cache CloudFront..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.DISTRIBUTION_ID_PROD }} \
            --paths "/*"
          echo "âœ… Cache invalidado!"
      
      - name: ğŸ“¢ Notificar Deploy (PROD)
        run: |
          echo "âœ… DEPLOY PROD CONCLUÃDO"
          echo "ğŸ”— URL: https://www.granjarecantofeliz.com/"
          echo "ğŸ“ Branch: main"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"

  # ========== RELATÃ“RIO ==========
  report:
    name: ğŸ“Š Gerar RelatÃ³rio
    needs: [validate, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“‹ Resumo do Build
        run: |
          echo "ğŸ“Š RELATÃ“RIO DE BUILD"
          echo "===================="
          echo "âœ… ValidaÃ§Ã£o: ${{ needs.validate.result }}"
          echo "âœ… Build: ${{ needs.build.result }}"
          echo "ğŸ“ Branch: ${{ github.ref_name }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ“… Data: $(date)"
