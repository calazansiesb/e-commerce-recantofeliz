<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Persist√™ncia - Recanto Feliz</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #45a049; }
        .product { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .price { font-size: 1.2em; font-weight: bold; color: #2196F3; }
        .original { color: #666; text-decoration: line-through; }
        .changed { color: #f44336; font-weight: bold; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Persist√™ncia de Dados</h1>
        
        <div class="section">
            <h2>1. Teste Autom√°tico</h2>
            <button class="button" onclick="executarTeste()">üß™ Executar Teste Completo</button>
            <button class="button" onclick="compararComSitePrincipal()">üîç Comparar com Site Principal</button>
            <div id="test-results"></div>
        </div>

        <div class="section">
            <h2>2. Produtos Atuais (localStorage)</h2>
            <div id="produtos-localStorage"></div>
        </div>

        <div class="section">
            <h2>3. Produtos Atuais (DataManager)</h2>
            <div id="produtos-dataManager"></div>
        </div>

        <div class="section">
            <h2>4. Teste Manual</h2>
            <p>Para testar manualmente:</p>
            <ol>
                <li>V√° para <a href="admin.html" target="_blank">admin.html</a></li>
                <li>Altere o pre√ßo de um produto</li>
                <li>Salve a altera√ß√£o</li>
                <li>Volte aqui e clique em "Executar Teste"</li>
                <li>V√° para <a href="index.html" target="_blank">index.html</a> e verifique</li>
                <li>Recarregue a p√°gina (F5) e verifique novamente</li>
            </ol>
        </div>
    </div>

    <script src="js/data-manager.js"></script>
    <script>
        let dataManager;
        let dadosOriginais = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (!window.dataManager) {
                    window.dataManager = new DataManager();
                }
                dataManager = window.dataManager;
                
                // Salvar estado original
                salvarEstadoOriginal();
                carregarProdutos();
            }, 500);
        });

        function salvarEstadoOriginal() {
            const localData = localStorage.getItem('granjaRecantoFelizData');
            if (localData) {
                dadosOriginais = JSON.parse(localData);
            }
        }

        function carregarProdutos() {
            // localStorage
            const localData = localStorage.getItem('granjaRecantoFelizData');
            if (localData) {
                const parsed = JSON.parse(localData);
                exibirProdutos(parsed.products, 'produtos-localStorage', 'localStorage');
            }

            // DataManager
            if (dataManager) {
                const products = dataManager.getActiveProducts();
                exibirProdutos(products, 'produtos-dataManager', 'DataManager');
            }
        }

        function exibirProdutos(products, containerId, source) {
            const container = document.getElementById(containerId);
            let html = '';

            products.slice(0, 3).forEach(product => { // Mostrar apenas os 3 primeiros
                html += `
                    <div class="product">
                        <strong>${product.name}</strong><br>
                        <span class="price">R$ ${product.price.toFixed(2)}</span><br>
                        <small>ID: ${product.id} | Categoria: ${product.category}</small><br>
                        <small>Fonte: ${source}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function executarTeste() {
            const resultsDiv = document.getElementById('test-results');
            let html = '<h3>Resultados do Teste:</h3>';

            // Teste 1: Verificar consist√™ncia entre localStorage e DataManager
            const localData = localStorage.getItem('granjaRecantoFelizData');
            const managerProducts = dataManager ? dataManager.getActiveProducts() : [];
            
            if (localData) {
                const localProducts = JSON.parse(localData).products;
                
                if (localProducts.length === managerProducts.length) {
                    html += '<div class="test-result success">‚úÖ Teste 1: Quantidade de produtos consistente</div>';
                } else {
                    html += `<div class="test-result error">‚ùå Teste 1: Quantidade inconsistente (localStorage: ${localProducts.length}, DataManager: ${managerProducts.length})</div>`;
                }

                // Teste 2: Verificar pre√ßos do primeiro produto
                if (localProducts[0] && managerProducts[0]) {
                    if (localProducts[0].price === managerProducts[0].price) {
                        html += '<div class="test-result success">‚úÖ Teste 2: Pre√ßos consistentes</div>';
                    } else {
                        html += `<div class="test-result error">‚ùå Teste 2: Pre√ßos inconsistentes (localStorage: R$ ${localProducts[0].price}, DataManager: R$ ${managerProducts[0].price})</div>`;
                    }
                }

                // Teste 3: Verificar se houve mudan√ßas desde o carregamento original
                const mudancas = detectarMudancas(dadosOriginais.products, localProducts);
                if (mudancas.length > 0) {
                    html += `<div class="test-result changed">üîÑ Teste 3: ${mudancas.length} altera√ß√µes detectadas desde o carregamento</div>`;
                    mudancas.forEach(mudanca => {
                        html += `<div style="margin-left: 20px; font-size: 0.9em;">‚Ä¢ Produto ${mudanca.id}: ${mudanca.campo} alterado de "${mudanca.anterior}" para "${mudanca.atual}"</div>`;
                    });
                } else {
                    html += '<div class="test-result success">‚úÖ Teste 3: Nenhuma altera√ß√£o detectada</div>';
                }

                // Teste 4: Simular refresh (recriar DataManager)
                const novoDataManager = new DataManager();
                const produtosAposRefresh = novoDataManager.getActiveProducts();
                
                if (JSON.stringify(managerProducts) === JSON.stringify(produtosAposRefresh)) {
                    html += '<div class="test-result success">‚úÖ Teste 4: Dados persistem ap√≥s simula√ß√£o de refresh</div>';
                } else {
                    html += '<div class="test-result error">‚ùå Teste 4: Dados N√ÉO persistem ap√≥s simula√ß√£o de refresh</div>';
                    
                    // Detalhes da diferen√ßa
                    if (managerProducts[0] && produtosAposRefresh[0]) {
                        html += `<div style="margin-left: 20px; font-size: 0.9em;">‚Ä¢ Antes: ${managerProducts[0].name} - R$ ${managerProducts[0].price}</div>`;
                        html += `<div style="margin-left: 20px; font-size: 0.9em;">‚Ä¢ Depois: ${produtosAposRefresh[0].name} - R$ ${produtosAposRefresh[0].price}</div>`;
                    }
                }

            } else {
                html += '<div class="test-result error">‚ùå Nenhum dado encontrado no localStorage</div>';
            }

            resultsDiv.innerHTML = html;

            // Recarregar produtos para mostrar estado atual
            carregarProdutos();
        }

        function detectarMudancas(originais, atuais) {
            const mudancas = [];
            
            for (let i = 0; i < Math.min(originais.length, atuais.length); i++) {
                const orig = originais[i];
                const atual = atuais[i];
                
                if (orig.price !== atual.price) {
                    mudancas.push({
                        id: orig.id,
                        campo: 'pre√ßo',
                        anterior: `R$ ${orig.price}`,
                        atual: `R$ ${atual.price}`
                    });
                }
                
                if (orig.name !== atual.name) {
                    mudancas.push({
                        id: orig.id,
                        campo: 'nome',
                        anterior: orig.name,
                        atual: atual.name
                    });
                }
            }
            
            return mudancas;
        }

        async function compararComSitePrincipal() {
            try {
                // Abrir o site principal em uma nova aba para compara√ß√£o
                const novaAba = window.open('index.html', '_blank');
                
                setTimeout(() => {
                    const resultsDiv = document.getElementById('test-results');
                    resultsDiv.innerHTML += `
                        <div class="test-result changed">
                            üîç Site principal aberto em nova aba para compara√ß√£o manual.<br>
                            <small>Compare os pre√ßos mostrados l√° com os dados aqui.</small>
                        </div>
                    `;
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao abrir site principal:', error);
            }
        }

        // Monitorar mudan√ßas no localStorage
        window.addEventListener('storage', function(e) {
            if (e.key === 'granjaRecantoFelizData') {
                console.log('üì° Mudan√ßa detectada no localStorage!');
                setTimeout(() => {
                    carregarProdutos();
                    executarTeste();
                }, 100);
            }
        });

        // Auto-refresh a cada 10 segundos
        setInterval(carregarProdutos, 10000);
    </script>
</body>
</html>
