<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de localStorage - Recanto Feliz</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #45a049; }
        .red { background: #f44336; }
        .red:hover { background: #da190b; }
        .blue { background: #2196F3; }
        .blue:hover { background: #0b7dda; }
        pre { background: #f8f8f8; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de localStorage - Diagn√≥stico Completo</h1>
        
        <div class="section">
            <h2>Controles de Teste</h2>
            <button class="button" onclick="testeBasico()">üß™ Teste B√°sico localStorage</button>
            <button class="button blue" onclick="testeDataManager()">‚öôÔ∏è Teste DataManager</button>
            <button class="button blue" onclick="simulaEdicao()">‚úèÔ∏è Simular Edi√ß√£o</button>
            <button class="button" onclick="restaurarProdutos()">üîß Restaurar Produtos Padr√£o</button>
            <button class="button red" onclick="limparTudo()">üóëÔ∏è Limpar Tudo</button>
        </div>

        <div id="resultados" class="section">
            <h2>Resultados dos Testes</h2>
            <div id="resultado-content">Clique em um teste para come√ßar...</div>
        </div>

        <div id="dados-atuais" class="section">
            <h2>Dados Atuais</h2>
            <pre id="dados-content">Carregando...</pre>
        </div>
    </div>

    <script src="js/data-manager.js"></script>
    <script>
        function log(message, type = 'info') {
            const content = document.getElementById('resultado-content');
            const time = new Date().toLocaleTimeString();
            const color = type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'black';
            content.innerHTML += `<div style="color: ${color}; margin: 5px 0;">[${time}] ${message}</div>`;
            console.log(message);
        }

        function mostrarDados() {
            const data = localStorage.getItem('granjaRecantoFelizData');
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    document.getElementById('dados-content').textContent = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    document.getElementById('dados-content').textContent = 'Erro ao parsear: ' + e.message;
                }
            } else {
                document.getElementById('dados-content').textContent = 'Nenhum dado encontrado';
            }
        }

        function testeBasico() {
            log('üß™ Iniciando teste b√°sico do localStorage...', 'info');
            
            // Limpar resultado anterior
            document.getElementById('resultado-content').innerHTML = '';
            
            // Teste 1: Verificar se localStorage funciona
            try {
                localStorage.setItem('teste', 'valor');
                const valor = localStorage.getItem('teste');
                if (valor === 'valor') {
                    log('‚úÖ localStorage funciona corretamente', 'success');
                } else {
                    log('‚ùå localStorage n√£o funciona', 'error');
                    return;
                }
                localStorage.removeItem('teste');
            } catch (e) {
                log('‚ùå Erro no localStorage: ' + e.message, 'error');
                return;
            }

            // Teste 2: Verificar dados atuais
            const dadosAtuais = localStorage.getItem('granjaRecantoFelizData');
            if (dadosAtuais) {
                try {
                    const parsed = JSON.parse(dadosAtuais);
                    log(`‚úÖ Dados encontrados: ${parsed.products?.length || 0} produtos`, 'success');
                    log(`üìÖ √öltima atualiza√ß√£o: ${parsed.lastUpdate || 'n√£o informado'}`, 'info');
                } catch (e) {
                    log('‚ùå Dados corrompidos: ' + e.message, 'error');
                }
            } else {
                log('‚ö†Ô∏è Nenhum dado encontrado no localStorage', 'warning');
            }

            // Teste 3: Salvar dados de teste
            const dadosTeste = {
                products: [
                    {
                        id: 999,
                        name: "Produto Teste",
                        price: 99.99,
                        category: "teste"
                    }
                ],
                lastUpdate: new Date().toISOString()
            };

            try {
                localStorage.setItem('granjaRecantoFelizData', JSON.stringify(dadosTeste));
                log('‚úÖ Dados de teste salvos', 'success');
                
                // Verificar se salvou
                const verificacao = localStorage.getItem('granjaRecantoFelizData');
                const parsedVerificacao = JSON.parse(verificacao);
                if (parsedVerificacao.products[0].name === 'Produto Teste') {
                    log('‚úÖ Dados recuperados corretamente', 'success');
                } else {
                    log('‚ùå Dados n√£o foram salvos corretamente', 'error');
                }
            } catch (e) {
                log('‚ùå Erro ao salvar dados de teste: ' + e.message, 'error');
            }

            mostrarDados();
        }

        function testeDataManager() {
            log('‚öôÔ∏è Iniciando teste do DataManager...', 'info');
            document.getElementById('resultado-content').innerHTML = '';

            try {
                // Criar nova inst√¢ncia
                const dm = new DataManager();
                log('‚úÖ DataManager criado', 'success');

                // Verificar se tem produtos
                const produtos = dm.getProducts();
                log(`üì¶ Produtos carregados: ${produtos.length}`, 'info');

                if (produtos.length > 0) {
                    const primeiroProduto = produtos[0];
                    log(`üîç Primeiro produto: ${primeiroProduto.name} - R$ ${primeiroProduto.price}`, 'info');
                    
                    // Tentar atualizar pre√ßo
                    const novoPreco = primeiroProduto.price + 0.01; // Adicionar 1 centavo
                    log(`üí∞ Alterando pre√ßo de R$ ${primeiroProduto.price} para R$ ${novoPreco}`, 'info');
                    
                    const resultado = dm.updateProduct(primeiroProduto.id, { price: novoPreco });
                    if (resultado) {
                        log('‚úÖ Produto atualizado com sucesso', 'success');
                        
                        // Verificar se a mudan√ßa persistiu
                        setTimeout(() => {
                            const produtosAtualizados = dm.getProducts();
                            const produtoVerificacao = produtosAtualizados.find(p => p.id === primeiroProduto.id);
                            if (produtoVerificacao && produtoVerificacao.price === novoPreco) {
                                log('‚úÖ Mudan√ßa persistiu no DataManager', 'success');
                            } else {
                                log('‚ùå Mudan√ßa N√ÉO persistiu no DataManager', 'error');
                            }

                            // Verificar no localStorage
                            const storageData = localStorage.getItem('granjaRecantoFelizData');
                            if (storageData) {
                                const parsedStorage = JSON.parse(storageData);
                                const produtoStorage = parsedStorage.products.find(p => p.id === primeiroProduto.id);
                                if (produtoStorage && produtoStorage.price === novoPreco) {
                                    log('‚úÖ Mudan√ßa persistiu no localStorage', 'success');
                                } else {
                                    log('‚ùå Mudan√ßa N√ÉO persistiu no localStorage', 'error');
                                    log(`üîç Pre√ßo no storage: R$ ${produtoStorage?.price}`, 'info');
                                }
                            }

                            mostrarDados();
                        }, 100);
                    } else {
                        log('‚ùå Falha ao atualizar produto', 'error');
                    }
                } else {
                    log('‚ùå Nenhum produto encontrado', 'error');
                }
            } catch (e) {
                log('‚ùå Erro no teste do DataManager: ' + e.message, 'error');
            }
        }

        function simulaEdicao() {
            log('‚úèÔ∏è Simulando edi√ß√£o completa...', 'info');
            document.getElementById('resultado-content').innerHTML = '';

            try {
                // Simular o fluxo completo de edi√ß√£o como no admin
                if (!window.dataManager) {
                    window.dataManager = new DataManager();
                }

                const produtos = window.dataManager.getProducts();
                if (produtos.length === 0) {
                    log('‚ùå Nenhum produto para editar', 'error');
                    return;
                }

                const produto = produtos[0];
                const precoOriginal = produto.price;
                const novoPreco = Math.round((precoOriginal + Math.random() * 10) * 100) / 100;

                log(`üéØ Produto selecionado: ${produto.name}`, 'info');
                log(`üí∞ Pre√ßo original: R$ ${precoOriginal}`, 'info');
                log(`üí∞ Novo pre√ßo: R$ ${novoPreco}`, 'info');

                // Simular salvamento
                const resultadoUpdate = window.dataManager.updateProduct(produto.id, { price: novoPreco });
                
                if (resultadoUpdate) {
                    log('‚úÖ updateProduct retornou sucesso', 'success');
                    
                    // Verifica√ß√µes imediatas
                    setTimeout(() => {
                        // 1. Verificar no DataManager
                        const produtoAtualizado = window.dataManager.getProducts().find(p => p.id === produto.id);
                        log(`üîç Pre√ßo no DataManager: R$ ${produtoAtualizado?.price}`, produtoAtualizado?.price === novoPreco ? 'success' : 'error');

                        // 2. Verificar no localStorage diretamente
                        const storageRaw = localStorage.getItem('granjaRecantoFelizData');
                        if (storageRaw) {
                            const storageParsed = JSON.parse(storageRaw);
                            const produtoStorage = storageParsed.products.find(p => p.id === produto.id);
                            log(`üîç Pre√ßo no localStorage: R$ ${produtoStorage?.price}`, produtoStorage?.price === novoPreco ? 'success' : 'error');
                            log(`üìÖ LastUpdate: ${storageParsed.lastUpdate}`, 'info');
                        }

                        // 3. Simular refresh (criar novo DataManager)
                        const novoDataManager = new DataManager();
                        const produtoAposRefresh = novoDataManager.getProducts().find(p => p.id === produto.id);
                        log(`üîç Pre√ßo ap√≥s refresh: R$ ${produtoAposRefresh?.price}`, produtoAposRefresh?.price === novoPreco ? 'success' : 'error');

                        mostrarDados();
                    }, 50);
                } else {
                    log('‚ùå updateProduct retornou falha', 'error');
                }
            } catch (e) {
                log('‚ùå Erro na simula√ß√£o: ' + e.message, 'error');
            }
        }

        function limparTudo() {
            if (confirm('‚ö†Ô∏è Isso ir√° limpar TODOS os dados. Continuar?')) {
                localStorage.removeItem('granjaRecantoFelizData');
                localStorage.removeItem('granjaRecantoFelizHistory');
                log('üóëÔ∏è Todos os dados foram limpos', 'warning');
                mostrarDados();
            }
        }

        function restaurarProdutos() {
            if (confirm('üîß Isso ir√° restaurar os produtos padr√£o. Continuar?')) {
                log('üîß Restaurando produtos padr√£o...', 'info');
                document.getElementById('resultado-content').innerHTML = '';
                
                try {
                    if (!window.dataManager) {
                        window.dataManager = new DataManager();
                    }
                    
                    const resultado = window.dataManager.restoreDefaultProducts();
                    if (resultado) {
                        log(`‚úÖ ${resultado.products.length} produtos restaurados`, 'success');
                        log(`üìÖ Timestamp: ${resultado.lastUpdate}`, 'info');
                        mostrarDados();
                    } else {
                        log('‚ùå Falha ao restaurar produtos', 'error');
                    }
                } catch (e) {
                    log('‚ùå Erro ao restaurar: ' + e.message, 'error');
                }
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            mostrarDados();
            
            // Monitor de mudan√ßas
            setInterval(mostrarDados, 5000);
        });
    </script>
</body>
</html>
