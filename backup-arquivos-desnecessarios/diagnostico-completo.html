<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Completo - Sistema de Dados</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #45a049; }
        .red { background: #f44336; }
        .red:hover { background: #da190b; }
        .blue { background: #2196F3; }
        .blue:hover { background: #0b7dda; }
        .orange { background: #ff9800; }
        .orange:hover { background: #e68900; }
        pre { background: #f8f8f8; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Completo - Sistema de Dados</h1>
        
        <div class="section">
            <h2>Controles de Diagn√≥stico</h2>
            <button class="button" onclick="diagnosticoCompleto()">üîç Diagn√≥stico Completo</button>
            <button class="button blue" onclick="lerLocalStorage()">üíæ Ler localStorage</button>
            <button class="button blue" onclick="lerSQLite()">üóÑÔ∏è Ler SQLite</button>
            <button class="button orange" onclick="sincronizarSQLite()">üîÑ Sincronizar SQLite ‚Üí localStorage</button>
            <button class="button orange" onclick="testarSalvamento()">üíæ Testar Salvamento</button>
            <button class="button orange" onclick="simularAdmin()">‚öôÔ∏è Simular Admin</button>
            <button class="button red" onclick="limparTudo()">üóëÔ∏è Limpar Tudo</button>
        </div>

        <div id="status" class="section">
            <h2>Status dos Sistemas</h2>
            <div id="status-content">Clique em "Diagn√≥stico Completo" para iniciar...</div>
        </div>

        <div class="grid">
            <div class="section">
                <h3>üì¶ localStorage</h3>
                <pre id="localStorage-content">Aguardando an√°lise...</pre>
            </div>
            
            <div class="section">
                <h3>üóÑÔ∏è SQLite</h3>
                <pre id="sqlite-content">Aguardando an√°lise...</pre>
            </div>
        </div>

        <div class="section">
            <h3>üß™ Logs de Teste</h3>
            <pre id="logs-content">Logs aparecer√£o aqui...</pre>
        </div>
    </div>

    <script src="js/data-manager.js"></script>
    <!-- sqlite disabled: <script src="js/sqlite-manager.js"></script> -->
    <script>
        function log(message, type = 'info') {
            const content = document.getElementById('logs-content');
            const time = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            content.textContent += `[${time}] ${prefix} ${message}\n`;
            console.log(`${prefix} ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs-content').textContent = '';
        }

        function diagnosticoCompleto() {
            clearLogs();
            log('üîç Iniciando diagn√≥stico completo do sistema...', 'info');
            
            let statusHtml = '';
            
            // 1. Verificar localStorage
            try {
                const localData = localStorage.getItem('granjaRecantoFelizData');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    statusHtml += `<div class="success">‚úÖ localStorage: ${parsed.products?.length || 0} produtos</div>`;
                    log(`localStorage: ${parsed.products?.length || 0} produtos encontrados`, 'success');
                } else {
                    statusHtml += `<div class="warning">‚ö†Ô∏è localStorage: Vazio</div>`;
                    log('localStorage est√° vazio', 'warning');
                }
            } catch (e) {
                statusHtml += `<div class="error">‚ùå localStorage: Erro - ${e.message}</div>`;
                log(`Erro no localStorage: ${e.message}`, 'error');
            }

            // 2. Verificar DataManager
            try {
                if (window.dataManager) {
                    const products = window.dataManager.getProducts();
                    statusHtml += `<div class="success">‚úÖ DataManager: ${products.length} produtos</div>`;
                    log(`DataManager: ${products.length} produtos carregados`, 'success');
                } else {
                    statusHtml += `<div class="warning">‚ö†Ô∏è DataManager: N√£o inicializado</div>`;
                    log('DataManager n√£o foi inicializado', 'warning');
                    
                    // Tentar criar
                    window.dataManager = new DataManager();
                    const products = window.dataManager.getProducts();
                    statusHtml += `<div class="success">‚úÖ DataManager criado: ${products.length} produtos</div>`;
                    log(`DataManager criado com ${products.length} produtos`, 'success');
                }
            } catch (e) {
                statusHtml += `<div class="error">‚ùå DataManager: Erro - ${e.message}</div>`;
                log(`Erro no DataManager: ${e.message}`, 'error');
            }

            // 3. Verificar SQLite
            try {
                if (window.sqliteManager) {
                    if (window.sqliteManager.db) {
                        const sqliteProducts = window.sqliteManager.getProducts();
                        statusHtml += `<div class="success">‚úÖ SQLite: ${sqliteProducts.length} produtos</div>`;
                        log(`SQLite: ${sqliteProducts.length} produtos encontrados`, 'success');
                    } else {
                        statusHtml += `<div class="warning">‚ö†Ô∏è SQLite: Database n√£o inicializado</div>`;
                        log('SQLite database n√£o est√° inicializado', 'warning');
                    }
                } else {
                    statusHtml += `<div class="warning">‚ö†Ô∏è SQLite: Manager n√£o dispon√≠vel</div>`;
                    log('SQLiteManager n√£o est√° dispon√≠vel', 'warning');
                }
            } catch (e) {
                statusHtml += `<div class="error">‚ùå SQLite: Erro - ${e.message}</div>`;
                log(`Erro no SQLite: ${e.message}`, 'error');
            }

            document.getElementById('status-content').innerHTML = statusHtml;
            
            // Carregar dados detalhados
            lerLocalStorage();
            lerSQLite();
        }

        function lerLocalStorage() {
            try {
                const data = localStorage.getItem('granjaRecantoFelizData');
                if (data) {
                    const parsed = JSON.parse(data);
                    document.getElementById('localStorage-content').textContent = JSON.stringify(parsed, null, 2);
                    log(`localStorage lido: ${parsed.products?.length || 0} produtos`, 'success');
                } else {
                    document.getElementById('localStorage-content').textContent = 'localStorage est√° vazio';
                    log('localStorage est√° vazio', 'warning');
                }
            } catch (e) {
                document.getElementById('localStorage-content').textContent = `Erro: ${e.message}`;
                log(`Erro ao ler localStorage: ${e.message}`, 'error');
            }
        }

        function lerSQLite() {
            try {
                if (window.sqliteManager && window.sqliteManager.db) {
                    const products = window.sqliteManager.getProducts();
                    document.getElementById('sqlite-content').textContent = JSON.stringify(products, null, 2);
                    log(`SQLite lido: ${products.length} produtos`, 'success');
                } else {
                    document.getElementById('sqlite-content').textContent = 'SQLite n√£o dispon√≠vel ou n√£o inicializado';
                    log('SQLite n√£o dispon√≠vel', 'warning');
                }
            } catch (e) {
                document.getElementById('sqlite-content').textContent = `Erro: ${e.message}`;
                log(`Erro ao ler SQLite: ${e.message}`, 'error');
            }
        }

        function testarSalvamento() {
            clearLogs();
            log('üíæ Testando salvamento de dados...', 'info');
            
            try {
                // Teste 1: Salvar no localStorage diretamente
                const dadosTeste = {
                    products: [
                        {
                            id: 999,
                            name: "Produto Teste",
                            price: 99.99,
                            category: "teste",
                            active: true
                        }
                    ],
                    lastUpdate: new Date().toISOString()
                };
                
                localStorage.setItem('granjaRecantoFelizData', JSON.stringify(dadosTeste));
                log('Dados salvos diretamente no localStorage', 'success');
                
                // Verificar se salvou
                const verificacao = localStorage.getItem('granjaRecantoFelizData');
                const parsed = JSON.parse(verificacao);
                if (parsed.products[0].name === 'Produto Teste') {
                    log('Verifica√ß√£o: Dados salvos corretamente', 'success');
                } else {
                    log('Verifica√ß√£o: Dados n√£o salvos corretamente', 'error');
                }
                
                // Teste 2: Usar DataManager
                if (window.dataManager) {
                    const resultado = window.dataManager.saveProducts(dadosTeste.products);
                    if (resultado) {
                        log('DataManager.saveProducts() retornou sucesso', 'success');
                    } else {
                        log('DataManager.saveProducts() retornou falha', 'error');
                    }
                }
                
                // Teste 3: Tentar updateProduct
                if (window.dataManager) {
                    const updateResult = window.dataManager.updateProduct(999, { price: 88.88 });
                    if (updateResult) {
                        log('DataManager.updateProduct() funcionou', 'success');
                    } else {
                        log('DataManager.updateProduct() falhou', 'error');
                    }
                }
                
                // Atualizar visualiza√ß√£o
                setTimeout(() => {
                    lerLocalStorage();
                    lerSQLite();
                }, 100);
                
            } catch (e) {
                log(`Erro no teste de salvamento: ${e.message}`, 'error');
            }
        }

        function simularAdmin() {
            clearLogs();
            log('‚öôÔ∏è Simulando fluxo do admin.html...', 'info');
            
            try {
                // Simular exatamente o que o admin faz
                if (!window.dataManager) {
                    window.dataManager = new DataManager();
                    log('DataManager criado', 'success');
                }
                
                // Obter produtos atuais
                const produtos = window.dataManager.getProducts();
                log(`Produtos atuais: ${produtos.length}`, 'info');
                
                if (produtos.length === 0) {
                    log('Nenhum produto encontrado, tentando restaurar padr√£o...', 'warning');
                    const restored = window.dataManager.restoreDefaultProducts();
                    if (restored) {
                        log(`${restored.products.length} produtos padr√£o restaurados`, 'success');
                    }
                    return;
                }
                
                // Simular edi√ß√£o do primeiro produto
                const produto = produtos[0];
                const novoPreco = Math.round((produto.price + Math.random() * 10) * 100) / 100;
                
                log(`Editando: ${produto.name}`, 'info');
                log(`Pre√ßo atual: R$ ${produto.price}`, 'info');
                log(`Novo pre√ßo: R$ ${novoPreco}`, 'info');
                
                // Simular salvamento (como no admin.js)
                const productData = {
                    ...produto,
                    price: novoPreco
                };
                
                let success = false;
                let sqliteSuccess = false;
                let dataManagerSuccess = false;
                
                // Tentar SQLite
                if (window.sqliteManager && window.sqliteManager.db) {
                    try {
                        sqliteSuccess = window.sqliteManager.updateProduct(produto.id, productData);
                        log(`SQLite save: ${sqliteSuccess ? 'sucesso' : 'falha'}`, sqliteSuccess ? 'success' : 'error');
                    } catch (e) {
                        log(`SQLite erro: ${e.message}`, 'error');
                    }
                }
                
                // Tentar DataManager
                try {
                    dataManagerSuccess = window.dataManager.updateProduct(produto.id, productData);
                    log(`DataManager save: ${dataManagerSuccess ? 'sucesso' : 'falha'}`, dataManagerSuccess ? 'success' : 'error');
                } catch (e) {
                    log(`DataManager erro: ${e.message}`, 'error');
                }
                
                success = sqliteSuccess || dataManagerSuccess;
                
                if (success) {
                    log('‚úÖ Simula√ß√£o de salvamento bem-sucedida', 'success');
                } else {
                    log('‚ùå Simula√ß√£o de salvamento falhou', 'error');
                }
                
                // Verificar se persistiu
                setTimeout(() => {
                    const produtosVerificacao = window.dataManager.getProducts();
                    const produtoVerificacao = produtosVerificacao.find(p => p.id === produto.id);
                    
                    if (produtoVerificacao && produtoVerificacao.price === novoPreco) {
                        log('‚úÖ Dados persistiram corretamente', 'success');
                    } else {
                        log(`‚ùå Dados n√£o persistiram (esperado: ${novoPreco}, atual: ${produtoVerificacao?.price})`, 'error');
                    }
                    
                    lerLocalStorage();
                    lerSQLite();
                }, 100);
                
            } catch (e) {
                log(`Erro na simula√ß√£o do admin: ${e.message}`, 'error');
            }
        }

        function sincronizarSQLite() {
            clearLogs();
            log('üîÑ Iniciando sincroniza√ß√£o SQLite ‚Üí localStorage...', 'info');
            
            try {
                if (!window.dataManager) {
                    window.dataManager = new DataManager();
                    log('DataManager criado', 'success');
                }
                
                const resultado = window.dataManager.syncFromSQLite();
                
                if (resultado) {
                    log(`‚úÖ ${resultado.products.length} produtos sincronizados com sucesso!`, 'success');
                    log(`üìÖ Timestamp: ${resultado.syncTimestamp}`, 'info');
                    
                    // Atualizar visualiza√ß√£o
                    setTimeout(() => {
                        diagnosticoCompleto();
                    }, 500);
                } else {
                    log('‚ùå Falha na sincroniza√ß√£o', 'error');
                }
            } catch (e) {
                log(`‚ùå Erro na sincroniza√ß√£o: ${e.message}`, 'error');
            }
        }

        function limparTudo() {
            if (confirm('‚ö†Ô∏è Isso ir√° limpar TODOS os dados. Continuar?')) {
                localStorage.clear();
                log('üóëÔ∏è localStorage limpo', 'warning');
                
                if (window.sqliteManager && window.sqliteManager.db) {
                    try {
                        // Tentar limpar SQLite tamb√©m
                        window.sqliteManager.clearAllData();
                        log('üóëÔ∏è SQLite limpo', 'warning');
                    } catch (e) {
                        log(`Aviso: N√£o foi poss√≠vel limpar SQLite: ${e.message}`, 'warning');
                    }
                }
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(diagnosticoCompleto, 500);
        });
    </script>
</body>
</html>
