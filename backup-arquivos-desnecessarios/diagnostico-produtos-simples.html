<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Produtos - Granja Recanto Feliz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; border-color: #28a745; color: #155724; }
        .warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .fix-btn { background: #28a745; }
        .fix-btn:hover { background: #1e7e34; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Produtos</h1>
        <p>Esta p√°gina verifica o status dos produtos e oferece corre√ß√µes autom√°ticas.</p>
        
        <div id="diagnostico-resultado">
            <div class="info">
                <strong>Iniciando diagn√≥stico...</strong>
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="executarDiagnostico()">üîç Executar Diagn√≥stico</button>
            <button onclick="corrigirProblemas()" class="fix-btn">üîß Corrigir Problemas</button>
            <button onclick="limparDados()" style="background: #dc3545;">üóëÔ∏è Limpar Dados</button>
            <button onclick="voltarSite()">üè† Voltar ao Site</button>
        </div>
        
        <div id="detalhes-tecnicos" style="display: none;">
            <h3>Detalhes T√©cnicos</h3>
            <pre id="log-detalhado"></pre>
        </div>
    </div>

    <script src="js/data-manager.js"></script>
    <script>
        let diagnosticoLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            diagnosticoLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            console.log(`${type.toUpperCase()}: ${message}`);
        }
        
        async function executarDiagnostico() {
            const resultado = document.getElementById('diagnostico-resultado');
            diagnosticoLog = [];
            
            resultado.innerHTML = '<div class="info"><strong>Executando diagn√≥stico...</strong></div>';
            
            try {
                log('Iniciando diagn√≥stico completo');
                
                // 1. Verificar localStorage
                log('Verificando localStorage...');
                const localData = localStorage.getItem('granjaRecantoFelizData');
                let localProducts = [];
                
                if (localData) {
                    try {
                        const parsed = JSON.parse(localData);
                        localProducts = parsed.products || [];
                        log(`localStorage: ${localProducts.length} produtos encontrados`);
                    } catch (e) {
                        log('Erro ao analisar localStorage: ' + e.message, 'error');
                    }
                } else {
                    log('localStorage vazio', 'warning');
                }
                
                // 2. Verificar arquivo JSON
                log('Verificando arquivo produtos.json...');
                let jsonProducts = [];
                try {
                    const response = await fetch('data/produtos.json', { cache: 'no-store' });
                    if (response.ok) {
                        const data = await response.json();
                        jsonProducts = data.products || [];
                        log(`produtos.json: ${jsonProducts.length} produtos encontrados`);
                    } else {
                        log(`Erro HTTP ao buscar produtos.json: ${response.status}`, 'error');
                    }
                } catch (e) {
                    log('Erro ao carregar produtos.json: ' + e.message, 'error');
                }
                
                // 3. Verificar DataManager
                log('Verificando DataManager...');
                let dataManagerProducts = [];
                try {
                    if (!window.dataManager) {
                        window.dataManager = new DataManager();
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    dataManagerProducts = await window.dataManager.getActiveProducts();
                    log(`DataManager: ${dataManagerProducts.length} produtos ativos`);
                } catch (e) {
                    log('Erro no DataManager: ' + e.message, 'error');
                }
                
                // 4. Verificar DOM
                log('Verificando DOM...');
                const productGrid = document.getElementById('product-grid');
                const renderedProducts = productGrid ? productGrid.children.length : 0;
                log(`DOM: ${renderedProducts} produtos renderizados`);
                
                // 5. Gerar relat√≥rio
                let html = '';
                
                if (localProducts.length > 0) {
                    html += '<div class="success"><strong>‚úÖ localStorage:</strong> ' + localProducts.length + ' produtos encontrados</div>';
                } else {
                    html += '<div class="error"><strong>‚ùå localStorage:</strong> Vazio ou inv√°lido</div>';
                }
                
                if (jsonProducts.length > 0) {
                    html += '<div class="success"><strong>‚úÖ produtos.json:</strong> ' + jsonProducts.length + ' produtos encontrados</div>';
                } else {
                    html += '<div class="error"><strong>‚ùå produtos.json:</strong> N√£o carregado</div>';
                }
                
                if (dataManagerProducts.length > 0) {
                    html += '<div class="success"><strong>‚úÖ DataManager:</strong> ' + dataManagerProducts.length + ' produtos ativos</div>';
                } else {
                    html += '<div class="error"><strong>‚ùå DataManager:</strong> Sem produtos</div>';
                }
                
                if (renderedProducts > 0) {
                    html += '<div class="success"><strong>‚úÖ DOM:</strong> ' + renderedProducts + ' produtos renderizados</div>';
                } else {
                    html += '<div class="error"><strong>‚ùå DOM:</strong> Nenhum produto renderizado</div>';
                }
                
                // Resumo
                const totalProblemas = (localProducts.length === 0 ? 1 : 0) + 
                                     (jsonProducts.length === 0 ? 1 : 0) + 
                                     (dataManagerProducts.length === 0 ? 1 : 0) + 
                                     (renderedProducts === 0 ? 1 : 0);
                
                if (totalProblemas === 0) {
                    html += '<div class="success"><strong>üéâ Diagn√≥stico Conclu√≠do:</strong> Todos os sistemas funcionando!</div>';
                } else {
                    html += `<div class="warning"><strong>‚ö†Ô∏è Diagn√≥stico Conclu√≠do:</strong> ${totalProblemas} problema(s) encontrado(s)</div>`;
                }
                
                resultado.innerHTML = html;
                
                // Mostrar detalhes t√©cnicos
                document.getElementById('log-detalhado').textContent = diagnosticoLog.join('\n');
                document.getElementById('detalhes-tecnicos').style.display = 'block';
                
                log('Diagn√≥stico conclu√≠do');
                
            } catch (error) {
                log('Erro cr√≠tico no diagn√≥stico: ' + error.message, 'error');
                resultado.innerHTML = '<div class="error"><strong>‚ùå Erro:</strong> ' + error.message + '</div>';
            }
        }
        
        async function corrigirProblemas() {
            const resultado = document.getElementById('diagnostico-resultado');
            resultado.innerHTML = '<div class="info"><strong>Aplicando corre√ß√µes...</strong></div>';
            
            try {
                log('Iniciando corre√ß√µes autom√°ticas');
                
                // 1. Produtos padr√£o
                const produtosPadrao = [
                    {
                        id: 1,
                        name: "Substrato BioF√©rtil 3 Anos",
                        category: "fertilizantes",
                        slogan: "Mais do que Adubo: um substrato vivo e completo.",
                        description: "Com um processo de matura√ß√£o de 3 anos, nosso substrato √© uma terra viva e completa, rica em mat√©ria org√¢nica e microrganismos ben√©ficos.",
                        price: 40.00,
                        image: "imagens/produtos/1/1.png",
                        stock: 25,
                        active: true
                    },
                    {
                        id: 2,
                        name: "FertiGota",
                        category: "fertilizantes",
                        slogan: "Adubo de galinha l√≠quido e potente.",
                        description: "Nosso fertilizante l√≠quido √© produzido atrav√©s de um processo de biodigestor anaer√≥bico, transformando dejetos de galinha em um adubo rico em nutrientes e de f√°cil absor√ß√£o pelas plantas. Ideal para hortas, jardins e vasos.",
                        price: 25.00,
                        image: "imagens/produtos/2/1.png",
                        stock: 40,
                        active: true
                    },
                    {
                        id: 3,
                        name: "Ovos Caipira 10",
                        category: "ovos",
                        slogan: "10 ovos frescos da granja.",
                        description: "Ovos caipira selecionados, direto da granja para sua mesa. Embalagem com 10 unidades.",
                        price: 18.00,
                        image: "imagens/produtos/3/1.jpeg",
                        stock: 120,
                        active: true
                    },
                    {
                        id: 4,
                        name: "Ovos Caipira 20",
                        category: "ovos",
                        slogan: "20 ovos frescos da granja.",
                        description: "Ovos caipira selecionados, direto da granja para sua mesa. Embalagem com 20 unidades.",
                        price: 30.00,
                        image: "imagens/produtos/4/1.jpeg",
                        stock: 80,
                        active: true
                    },
                    {
                        id: 5,
                        name: "Ovos Caipira 30",
                        category: "ovos",
                        slogan: "30 ovos frescos da granja.",
                        description: "Ovos caipira selecionados, direto da granja para sua mesa. Embalagem com 30 unidades.",
                        price: 45.00,
                        image: "imagens/produtos/5/1.png",
                        stock: 50,
                        active: true
                    },
                    {
                        id: 6,
                        name: "Galinha Caipira Picada",
                        category: "aves",
                        slogan: "Galinha caipira cortada, pronta para cozinhar.",
                        description: "Galinha caipira picada, sabor aut√™ntico da ro√ßa. Ideal para receitas tradicionais.",
                        price: 60.00,
                        image: "imagens/produtos/6/1.png",
                        stock: 15,
                        active: true
                    },
                    {
                        id: 7,
                        name: "Galinha Caipira Inteira",
                        category: "aves",
                        slogan: "Galinha caipira inteira, fresca e saborosa.",
                        description: "Galinha caipira inteira, criada solta e alimentada naturalmente. Perfeita para assados e cozidos.",
                        price: 110.00,
                        image: "imagens/produtos/7/1.png",
                        stock: 8,
                        active: true
                    }
                ];
                
                // 2. Salvar no localStorage
                const dadosCorrigidos = {
                    products: produtosPadrao,
                    lastUpdate: new Date().toISOString(),
                    source: 'diagnostic-fix',
                    correctedAt: new Date().toISOString()
                };
                
                localStorage.setItem('granjaRecantoFelizData', JSON.stringify(dadosCorrigidos));
                log('localStorage corrigido com 7 produtos padr√£o');
                
                // 3. Recriar DataManager
                window.dataManager = new DataManager();
                await new Promise(resolve => setTimeout(resolve, 500));
                log('DataManager reinicializado');
                
                // 4. Verificar corre√ß√£o
                const produtosVerificacao = await window.dataManager.getActiveProducts();
                log(`Verifica√ß√£o: ${produtosVerificacao.length} produtos carregados`);
                
                resultado.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Corre√ß√£o Aplicada!</strong><br>
                        ‚Ä¢ ${produtosPadrao.length} produtos restaurados<br>
                        ‚Ä¢ localStorage atualizado<br>
                        ‚Ä¢ DataManager reinicializado<br>
                        ‚Ä¢ ${produtosVerificacao.length} produtos verificados
                    </div>
                    <div class="info">
                        <strong>üìã Pr√≥ximos passos:</strong><br>
                        1. Volte ao site principal<br>
                        2. Recarregue a p√°gina se necess√°rio<br>
                        3. Os produtos devem aparecer normalmente
                    </div>
                `;
                
                log('Corre√ß√µes aplicadas com sucesso');
                
            } catch (error) {
                log('Erro ao aplicar corre√ß√µes: ' + error.message, 'error');
                resultado.innerHTML = '<div class="error"><strong>‚ùå Erro:</strong> ' + error.message + '</div>';
            }
        }
        
        function limparDados() {
            if (confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                localStorage.removeItem('granjaRecantoFelizData');
                localStorage.removeItem('granjaRecantoFelizHistory');
                localStorage.removeItem('carrinho');
                
                document.getElementById('diagnostico-resultado').innerHTML = `
                    <div class="warning">
                        <strong>üóëÔ∏è Dados Limpos!</strong><br>
                        Todos os dados foram removidos. Recarregue a p√°gina para reinicializar.
                    </div>
                `;
                
                log('Todos os dados foram limpos');
            }
        }
        
        function voltarSite() {
            window.location.href = 'index.html';
        }
        
        // Executar diagn√≥stico automaticamente ao carregar
        document.addEventListener('DOMContentLoaded', executarDiagnostico);
    </script>
</body>
</html>