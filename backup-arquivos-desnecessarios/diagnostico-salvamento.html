<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiagnÃ³stico RÃ¡pido - Salvamento de Produtos</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f0f0f0; }
        .log { background: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { border-left: 5px solid #28a745; }
        .error { border-left: 5px solid #dc3545; }
        .warning { border-left: 5px solid #ffc107; }
        .info { border-left: 5px solid #17a2b8; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸ”§ DiagnÃ³stico RÃ¡pido - Sistema de Salvamento</h1>
    
    <button onclick="executarDiagnostico()">ğŸ” Executar DiagnÃ³stico Completo</button>
    <button onclick="testarSalvamento()">ğŸ’¾ Testar Salvamento Manual</button>
    <button onclick="limparLogs()">ğŸ—‘ï¸ Limpar Logs</button>
    <button onclick="verificarPersistencia()">ğŸ”„ Verificar PersistÃªncia</button>
    
    <div id="logs"></div>

    <!-- Scripts necessÃ¡rios -->
    <script src="js/persistence-fix.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/scripts.js"></script>
    
    <script>
        let logsContainer = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsContainer.appendChild(div);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function limparLogs() {
            logsContainer.innerHTML = '';
        }
        
        function executarDiagnostico() {
            log('ğŸš€ Iniciando diagnÃ³stico completo...', 'info');
            
            // 1. Verificar se scripts carregaram
            log('ğŸ“‹ 1. Verificando carregamento de scripts:', 'info');
            log(`   - PersistenceManager: ${window.persistenceManager ? 'âœ… Carregado' : 'âŒ NÃ£o encontrado'}`, window.persistenceManager ? 'success' : 'error');
            log(`   - DataManager: ${window.dataManager ? 'âœ… Carregado' : 'âŒ NÃ£o encontrado'}`, window.dataManager ? 'success' : 'error');
            log(`   - SQLiteManager: ${window.sqliteManager ? 'âœ… Carregado' : 'âŒ NÃ£o encontrado'}`, window.sqliteManager ? 'success' : 'error');
            
            // 2. Verificar dados atuais
            log('ğŸ“‹ 2. Verificando dados atuais:', 'info');
            
            if (window.dataManager) {
                const produtos = window.dataManager.getProducts();
                log(`   - Produtos no DataManager: ${produtos.length}`, produtos.length > 0 ? 'success' : 'warning');
                
                if (produtos.length > 0) {
                    const primeiro = produtos[0];
                    log(`   - Primeiro produto: ${primeiro.name} - R$ ${primeiro.price}`, 'info');
                }
            }
            
            // 3. Verificar localStorage
            log('ğŸ“‹ 3. Verificando localStorage:', 'info');
            const lsData = localStorage.getItem('granjaRecantoFelizData');
            if (lsData) {
                try {
                    const parsed = JSON.parse(lsData);
                    log(`   - Produtos no localStorage: ${parsed.products ? parsed.products.length : 0}`, 'success');
                    log(`   - Ãšltima atualizaÃ§Ã£o: ${parsed.lastUpdate || 'N/A'}`, 'info');
                } catch (e) {
                    log(`   - Erro ao ler localStorage: ${e.message}`, 'error');
                }
            } else {
                log('   - localStorage vazio ou nÃ£o encontrado', 'warning');
            }
            
            // 4. Verificar dados persistentes
            log('ğŸ“‹ 4. Verificando dados persistentes:', 'info');
            if (window.persistenceManager) {
                const persistentData = window.persistenceManager.loadPersistentData();
                if (persistentData && persistentData.products) {
                    log(`   - Produtos persistentes: ${persistentData.products.length}`, 'success');
                    log(`   - Fonte: ${persistentData.source || 'desconhecida'}`, 'info');
                } else {
                    log('   - Nenhum dado persistente encontrado', 'warning');
                }
            }
            
            log('âœ… DiagnÃ³stico concluÃ­do', 'success');
        }
        
        function testarSalvamento() {
            log('ğŸ§ª Iniciando teste de salvamento...', 'info');
            
            if (!window.dataManager) {
                log('âŒ DataManager nÃ£o disponÃ­vel para teste', 'error');
                return;
            }
            
            try {
                // Obter produtos atuais
                const produtos = window.dataManager.getProducts();
                log(`ğŸ“¦ Produtos atuais: ${produtos.length}`, 'info');
                
                if (produtos.length === 0) {
                    log('âš ï¸ Nenhum produto para testar', 'warning');
                    return;
                }
                
                // Fazer uma alteraÃ§Ã£o de teste
                const produtoTeste = {...produtos[0]};
                const precoOriginal = produtoTeste.price;
                const novoPreco = precoOriginal + 0.01; // Adicionar 1 centavo
                
                log(`ğŸ”§ Alterando preÃ§o de teste: R$ ${precoOriginal} â†’ R$ ${novoPreco}`, 'info');
                
                // Tentar salvar
                const sucesso = window.dataManager.updateProduct(produtoTeste.id, {price: novoPreco});
                
                if (sucesso) {
                    log('âœ… Salvamento via DataManager: SUCESSO', 'success');
                    
                    // Verificar se foi salvo mesmo
                    setTimeout(() => {
                        const produtosVerificacao = window.dataManager.getProducts();
                        const produtoVerificado = produtosVerificacao.find(p => p.id === produtoTeste.id);
                        
                        if (produtoVerificado && produtoVerificado.price === novoPreco) {
                            log('âœ… VerificaÃ§Ã£o: Dados persistiram no DataManager', 'success');
                        } else {
                            log('âŒ VerificaÃ§Ã£o: Dados NÃƒO persistiram no DataManager', 'error');
                        }
                        
                        // Verificar localStorage
                        const lsCheck = localStorage.getItem('granjaRecantoFelizData');
                        if (lsCheck) {
                            const lsParsed = JSON.parse(lsCheck);
                            const lsProduto = lsParsed.products?.find(p => p.id === produtoTeste.id);
                            
                            if (lsProduto && lsProduto.price === novoPreco) {
                                log('âœ… VerificaÃ§Ã£o: Dados persistiram no localStorage', 'success');
                            } else {
                                log('âŒ VerificaÃ§Ã£o: Dados NÃƒO persistiram no localStorage', 'error');
                                log(`   Expected: R$ ${novoPreco}, Got: R$ ${lsProduto?.price || 'undefined'}`, 'error');
                            }
                        }
                        
                        // Restaurar preÃ§o original
                        window.dataManager.updateProduct(produtoTeste.id, {price: precoOriginal});
                        log(`ğŸ”„ PreÃ§o restaurado para R$ ${precoOriginal}`, 'info');
                        
                    }, 100);
                    
                } else {
                    log('âŒ Salvamento via DataManager: FALHOU', 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro durante teste de salvamento: ${error.message}`, 'error');
            }
        }
        
        function verificarPersistencia() {
            log('ğŸ” Verificando sistema de persistÃªncia...', 'info');
            
            if (!window.persistenceManager) {
                log('âŒ PersistenceManager nÃ£o encontrado', 'error');
                return;
            }
            
            try {
                // Testar salvamento persistente
                const dadosTeste = {
                    products: window.dataManager ? window.dataManager.getProducts() : [],
                    lastUpdate: new Date().toISOString(),
                    source: 'teste_diagnostico'
                };
                
                log(`ğŸ“¤ Tentando salvar ${dadosTeste.products.length} produtos de forma persistente...`, 'info');
                
                window.persistenceManager.savePersistentData(dadosTeste);
                log('âœ… Salvamento persistente executado', 'success');
                
                // Verificar se foi salvo
                setTimeout(() => {
                    const dadosRecuperados = window.persistenceManager.loadPersistentData();
                    
                    if (dadosRecuperados && dadosRecuperados.products) {
                        log(`âœ… Dados recuperados: ${dadosRecuperados.products.length} produtos`, 'success');
                        log(`ğŸ“… Fonte: ${dadosRecuperados.source}`, 'info');
                    } else {
                        log('âŒ Falha ao recuperar dados persistentes', 'error');
                    }
                }, 100);
                
            } catch (error) {
                log(`âŒ Erro na verificaÃ§Ã£o de persistÃªncia: ${error.message}`, 'error');
            }
        }
        
        // Executar diagnÃ³stico automaticamente ao carregar
        window.addEventListener('load', () => {
            setTimeout(executarDiagnostico, 1000);
        });
    </script>
</body>
</html>
