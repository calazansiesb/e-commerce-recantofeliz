<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparar: Site vs Banco SQLite - Granja Recanto Feliz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .source-panel {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        
        .source-panel.site {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .source-panel.banco {
            border-color: #007bff;
            background: #f8f9ff;
        }
        
        .product-item {
            border: 1px solid #eee;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: white;
        }
        
        .product-item.different {
            border-color: #dc3545;
            background: #fff5f5;
        }
        
        .product-item.same {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .product-name {
            font-weight: bold;
            color: #2D5016;
            margin-bottom: 5px;
        }
        
        .product-price {
            font-size: 1.1em;
            color: #dc3545;
            font-weight: bold;
        }
        
        .product-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        button {
            background-color: #2D5016;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #1a3009;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Compara√ß√£o: Site Principal vs Banco SQLite</h1>
        <p>Esta ferramenta compara os valores dos produtos exibidos no site com os valores realmente salvos no banco de dados SQLite.</p>
        
        <div id="status-container">
            <div class="status info">‚è≥ Preparando compara√ß√£o...</div>
        </div>
        
        <div>
            <button onclick="compararValores()">üîÑ Comparar Site vs Banco</button>
            <button onclick="verificarBanco()">üóÑÔ∏è Verificar Banco SQLite</button>
            <button onclick="testarSalvamento()">üíæ Testar Salvamento</button>
            <button onclick="limparLog()">üßπ Limpar Log</button>
        </div>
        
        <div class="log" id="log-container"></div>
        
        <div class="summary" id="summary-container" style="display: none;">
            <h3>üìä Resumo da Compara√ß√£o</h3>
            <div id="summary-content"></div>
        </div>
        
        <div class="comparison-grid" id="comparison-grid" style="display: none;">
            <div class="source-panel site">
                <h3>üåê Site Principal (Valores Exibidos)</h3>
                <div id="site-products"></div>
            </div>
            
            <div class="source-panel banco">
                <h3>üóÑÔ∏è Banco SQLite (Valores Salvos)</h3>
                <div id="banco-products"></div>
            </div>
        </div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="js/data-manager.js"></script>
    <!-- sqlite disabled: <script src="js/sqlite-manager.js"></script> -->
    
    <script>
        let logContainer;
        let produtosSite = [];
        let produtosBanco = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('log-container');
            log('üöÄ Ferramenta de compara√ß√£o Site vs Banco carregada');
            
            setTimeout(() => {
                if (window.dataManager) {
                    log('‚úÖ DataManager encontrado');
                } else {
                    log('‚ö†Ô∏è DataManager n√£o encontrado, criando...');
                    window.dataManager = new DataManager();
                }
                
                // Auto-executar compara√ß√£o
                compararValores();
            }, 1000);
        });
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            if (logContainer) {
                logContainer.innerHTML += logMessage + '\n';
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }
        
        function updateStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-container');
            statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function compararValores() {
            log('üîç Iniciando compara√ß√£o Site vs Banco SQLite...');
            updateStatus('üîÑ Comparando valores entre site e banco de dados...', 'info');
            
            try {
                // 1. Obter produtos do site
                produtosSite = await obterProdutosSite();
                log(`üåê Site: ${produtosSite.length} produtos encontrados`);
                
                // 2. Obter produtos do banco SQLite
                produtosBanco = await obterProdutosBanco();
                log(`üóÑÔ∏è Banco: ${produtosBanco.length} produtos encontrados`);
                
                // 3. Comparar os dados
                const resultado = compararDados(produtosSite, produtosBanco);
                
                // 4. Exibir resultados
                exibirComparacao(resultado);
                
                // 5. Mostrar resumo
                exibirResumo(resultado);
                
                if (resultado.diferencas > 0) {
                    updateStatus(`‚ö†Ô∏è ${resultado.diferencas} diferen√ßas encontradas entre site e banco`, 'warning');
                } else if (produtosSite.length === 0 && produtosBanco.length === 0) {
                    updateStatus('‚ö†Ô∏è Nenhum produto encontrado em ambas as fontes', 'warning');
                } else {
                    updateStatus('‚úÖ Site e banco est√£o sincronizados', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Erro na compara√ß√£o: ${error.message}`);
                updateStatus('‚ùå Erro ao comparar valores', 'error');
            }
        }
        
        async function obterProdutosSite() {
            log('üåê Obtendo produtos do site principal...');
            
            if (!window.dataManager) {
                log('‚ö†Ô∏è DataManager n√£o dispon√≠vel, criando...');
                window.dataManager = new DataManager();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const produtos = window.dataManager.getProducts();
            log(`üìä DataManager retornou ${produtos.length} produtos`);
            
            if (produtos.length > 0) {
                log(`üîç Primeiro produto do site: ${produtos[0].name} - R$ ${produtos[0].price}`);
            }
            
            return produtos;
        }
        
        async function obterProdutosBanco() {
            log('üóÑÔ∏è Obtendo produtos do banco SQLite...');
            
            try {
                // Verificar se SQLite est√° dispon√≠vel
                if (!window.sqliteManager) {
                    log('‚ö†Ô∏è SQLiteManager n√£o encontrado, tentando inicializar...');
                    
                    if (window.initSQLiteManager) {
                        await window.initSQLiteManager();
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                if (window.sqliteManager && window.sqliteManager.db) {
                    const produtos = window.sqliteManager.getProducts();
                    log(`üìä SQLite cont√©m ${produtos.length} produtos`);
                    
                    if (produtos.length > 0) {
                        log(`üîç Primeiro produto do banco: ${produtos[0].name} - R$ ${produtos[0].price}`);
                    }
                    
                    return produtos;
                } else {
                    log('‚ùå SQLite n√£o est√° dispon√≠vel');
                    return [];
                }
                
            } catch (error) {
                log(`‚ùå Erro ao acessar banco SQLite: ${error.message}`);
                return [];
            }
        }
        
        function compararDados(produtosSite, produtosBanco) {
            log('üîÑ Comparando dados...');
            
            const resultado = {
                total: Math.max(produtosSite.length, produtosBanco.length),
                iguais: 0,
                diferencas: 0,
                somenteNoSite: [],
                somenteNoBanco: [],
                diferentes: []
            };
            
            // Criar mapas para facilitar compara√ß√£o
            const mapSite = new Map();
            const mapBanco = new Map();
            
            produtosSite.forEach(p => mapSite.set(p.id, p));
            produtosBanco.forEach(p => mapBanco.set(p.id, p));
            
            // Obter todos os IDs √∫nicos
            const todosIds = new Set([...mapSite.keys(), ...mapBanco.keys()]);
            
            todosIds.forEach(id => {
                const produtoSite = mapSite.get(id);
                const produtoBanco = mapBanco.get(id);
                
                if (produtoSite && produtoBanco) {
                    // Produto existe em ambos - comparar valores
                    const diferencas = [];
                    
                    if (produtoSite.name !== produtoBanco.name) {
                        diferencas.push(`Nome: "${produtoSite.name}" vs "${produtoBanco.name}"`);
                    }
                    
                    if (produtoSite.price !== produtoBanco.price) {
                        diferencas.push(`Pre√ßo: R$ ${produtoSite.price} vs R$ ${produtoBanco.price}`);
                    }
                    
                    if (produtoSite.category !== produtoBanco.category) {
                        diferencas.push(`Categoria: "${produtoSite.category}" vs "${produtoBanco.category}"`);
                    }
                    
                    if (diferencas.length > 0) {
                        resultado.diferencas++;
                        resultado.diferentes.push({
                            id,
                            nome: produtoSite.name || produtoBanco.name,
                            diferencas,
                            site: produtoSite,
                            banco: produtoBanco
                        });
                        log(`‚ö†Ô∏è Diferen√ßas no produto ${id}: ${diferencas.join(', ')}`);
                    } else {
                        resultado.iguais++;
                        log(`‚úÖ Produto ${id} id√™ntico em ambos`);
                    }
                    
                } else if (produtoSite && !produtoBanco) {
                    resultado.somenteNoSite.push(produtoSite);
                    log(`üåê Produto ${id} existe apenas no site: ${produtoSite.name}`);
                    
                } else if (!produtoSite && produtoBanco) {
                    resultado.somenteNoBanco.push(produtoBanco);
                    log(`üóÑÔ∏è Produto ${id} existe apenas no banco: ${produtoBanco.name}`);
                }
            });
            
            log(`üìä Compara√ß√£o conclu√≠da: ${resultado.iguais} iguais, ${resultado.diferencas} diferentes`);
            return resultado;
        }
        
        function exibirComparacao(resultado) {
            log('üìã Exibindo compara√ß√£o visual...');
            
            const grid = document.getElementById('comparison-grid');
            const siteContainer = document.getElementById('site-products');
            const bancoContainer = document.getElementById('banco-products');
            
            // Limpar containers
            siteContainer.innerHTML = '';
            bancoContainer.innerHTML = '';
            
            // Criar mapa de produtos por ID
            const mapSite = new Map();
            const mapBanco = new Map();
            
            produtosSite.forEach(p => mapSite.set(p.id, p));
            produtosBanco.forEach(p => mapBanco.set(p.id, p));
            
            // Obter todos os IDs √∫nicos
            const todosIds = new Set([...mapSite.keys(), ...mapBanco.keys()]);
            
            todosIds.forEach(id => {
                const produtoSite = mapSite.get(id);
                const produtoBanco = mapBanco.get(id);
                
                // Determinar se s√£o iguais ou diferentes
                let saoIguais = false;
                if (produtoSite && produtoBanco) {
                    saoIguais = (
                        produtoSite.name === produtoBanco.name &&
                        produtoSite.price === produtoBanco.price &&
                        produtoSite.category === produtoBanco.category
                    );
                }
                
                const cssClass = saoIguais ? 'same' : 'different';
                
                // Criar elemento para o site
                if (produtoSite) {
                    siteContainer.innerHTML += `
                        <div class="product-item ${cssClass}">
                            <div class="product-name">${produtoSite.name}</div>
                            <div class="product-price">R$ ${produtoSite.price.toFixed(2)}</div>
                            <div class="product-details">
                                ID: ${produtoSite.id} | Categoria: ${produtoSite.category || 'N/A'}
                            </div>
                        </div>
                    `;
                } else {
                    siteContainer.innerHTML += `
                        <div class="product-item different">
                            <div class="product-name">‚ùå Produto ${id} n√£o encontrado no site</div>
                        </div>
                    `;
                }
                
                // Criar elemento para o banco
                if (produtoBanco) {
                    bancoContainer.innerHTML += `
                        <div class="product-item ${cssClass}">
                            <div class="product-name">${produtoBanco.name}</div>
                            <div class="product-price">R$ ${produtoBanco.price.toFixed(2)}</div>
                            <div class="product-details">
                                ID: ${produtoBanco.id} | Categoria: ${produtoBanco.category || 'N/A'}
                            </div>
                        </div>
                    `;
                } else {
                    bancoContainer.innerHTML += `
                        <div class="product-item different">
                            <div class="product-name">‚ùå Produto ${id} n√£o encontrado no banco</div>
                        </div>
                    `;
                }
            });
            
            grid.style.display = 'grid';
        }
        
        function exibirResumo(resultado) {
            const summaryContainer = document.getElementById('summary-container');
            const summaryContent = document.getElementById('summary-content');
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #28a745;">${resultado.iguais}</div>
                        <div>Produtos Id√™nticos</div>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #856404;">${resultado.diferencas}</div>
                        <div>Produtos Diferentes</div>
                    </div>
                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #0c5460;">${resultado.somenteNoSite.length}</div>
                        <div>S√≥ no Site</div>
                    </div>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #721c24;">${resultado.somenteNoBanco.length}</div>
                        <div>S√≥ no Banco</div>
                    </div>
                </div>
            `;
            
            if (resultado.diferentes.length > 0) {
                html += `
                    <h4>üîç Detalhes das Diferen√ßas:</h4>
                    <ul>
                `;
                resultado.diferentes.forEach(diff => {
                    html += `<li><strong>${diff.nome}</strong>: ${diff.diferencas.join(', ')}</li>`;
                });
                html += `</ul>`;
            }
            
            // Diagn√≥stico
            html += `<h4>ü©∫ Diagn√≥stico:</h4>`;
            
            if (resultado.diferencas === 0 && resultado.somenteNoSite.length === 0 && resultado.somenteNoBanco.length === 0) {
                html += `<p style="color: #28a745; font-weight: bold;">‚úÖ Perfeito! Site e banco est√£o completamente sincronizados.</p>`;
            } else {
                html += `<p style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è H√° inconsist√™ncias entre site e banco:</p><ul>`;
                
                if (resultado.diferencas > 0) {
                    html += `<li><strong>Produtos com valores diferentes:</strong> O site est√° exibindo valores diferentes dos salvos no banco. Isso indica que as edi√ß√µes n√£o est√£o sendo persistidas ou o site est√° usando dados est√°ticos.</li>`;
                }
                
                if (resultado.somenteNoSite.length > 0) {
                    html += `<li><strong>Produtos apenas no site:</strong> O site est√° exibindo produtos que n√£o existem no banco. Pode indicar dados hardcoded ou cache desatualizado.</li>`;
                }
                
                if (resultado.somenteNoBanco.length > 0) {
                    html += `<li><strong>Produtos apenas no banco:</strong> Existem produtos salvos no banco que n√£o aparecem no site. Pode indicar problema na sincroniza√ß√£o.</li>`;
                }
                
                html += `</ul>`;
            }
            
            summaryContent.innerHTML = html;
            summaryContainer.style.display = 'block';
        }
        
        async function verificarBanco() {
            log('üóÑÔ∏è Verificando estado do banco SQLite...');
            updateStatus('üîç Analisando banco de dados...', 'info');
            
            try {
                if (!window.sqliteManager) {
                    log('‚ö†Ô∏è SQLiteManager n√£o encontrado, tentando inicializar...');
                    if (window.initSQLiteManager) {
                        await window.initSQLiteManager();
                    }
                }
                
                if (window.sqliteManager && window.sqliteManager.db) {
                    log('‚úÖ SQLite est√° funcionando');
                    const produtos = window.sqliteManager.getProducts();
                    log(`üìä Banco cont√©m ${produtos.length} produtos`);
                    
                    if (produtos.length > 0) {
                        produtos.forEach((p, i) => {
                            log(`${i+1}. ${p.name} - R$ ${p.price} (ID: ${p.id})`);
                        });
                    }
                    
                    updateStatus(`‚úÖ Banco SQLite OK - ${produtos.length} produtos`, 'success');
                } else {
                    log('‚ùå SQLite n√£o est√° dispon√≠vel');
                    updateStatus('‚ùå Banco SQLite n√£o dispon√≠vel', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao verificar banco: ${error.message}`);
                updateStatus('‚ùå Erro ao acessar banco', 'error');
            }
        }
        
        async function testarSalvamento() {
            log('üíæ Iniciando teste de salvamento no banco...');
            updateStatus('üß™ Testando se dados s√£o realmente salvos no banco...', 'info');
            
            try {
                // 1. Verificar se SQLite est√° dispon√≠vel
                if (!window.sqliteManager || !window.sqliteManager.db) {
                    log('‚ùå SQLite n√£o dispon√≠vel para teste');
                    updateStatus('‚ùå Banco SQLite n√£o dispon√≠vel', 'error');
                    return;
                }
                
                // 2. Capturar estado inicial do banco
                const estadoInicialBanco = window.sqliteManager.getProducts();
                log(`üìä Estado inicial do banco: ${estadoInicialBanco.length} produtos`);
                
                if (estadoInicialBanco.length === 0) {
                    log('‚ùå Nenhum produto no banco para testar');
                    updateStatus('‚ùå Banco vazio - nenhum produto para testar', 'error');
                    return;
                }
                
                // 3. Testar salvamento direto no SQLite
                const produtoTeste = {...estadoInicialBanco[0]};
                const precoOriginal = produtoTeste.price;
                const novoPreco = precoOriginal + 0.01;
                
                log(`üîß Testando salvamento do produto "${produtoTeste.name}"`);
                log(`üí∞ Pre√ßo original no banco: R$ ${precoOriginal.toFixed(2)}`);
                log(`üí∞ Novo pre√ßo para testar: R$ ${novoPreco.toFixed(2)}`);
                
                // 4. Salvar diretamente no SQLite
                produtoTeste.price = novoPreco;
                const sucessoSQLite = window.sqliteManager.updateProduct(produtoTeste.id, produtoTeste);
                
                if (sucessoSQLite) {
                    log('‚úÖ Produto atualizado no SQLite');
                    
                    // 5. Verificar se realmente foi salvo no banco
                    const produtoVerificacao = window.sqliteManager.getProducts().find(p => p.id === produtoTeste.id);
                    
                    if (produtoVerificacao && produtoVerificacao.price === novoPreco) {
                        log('‚úÖ TESTE PASSOU: Dados foram salvos no banco SQLite');
                        
                        // 6. Verificar se o site reflete a mudan√ßa
                        await new Promise(resolve => setTimeout(resolve, 500));
                        const produtosSiteAtuais = await obterProdutosSite();
                        const produtoNoSite = produtosSiteAtuais.find(p => p.id === produtoTeste.id);
                        
                        if (produtoNoSite && produtoNoSite.price === novoPreco) {
                            log('‚úÖ PERFEITO: Site tamb√©m reflete a mudan√ßa do banco');
                            updateStatus('‚úÖ Salvamento funciona - Site e banco sincronizados', 'success');
                        } else {
                            log('‚ö†Ô∏è ATEN√á√ÉO: Banco foi atualizado, mas site n√£o reflete a mudan√ßa');
                            log(`üí∞ Pre√ßo no banco: R$ ${produtoVerificacao.price.toFixed(2)}`);
                            log(`üí∞ Pre√ßo no site: R$ ${produtoNoSite?.price?.toFixed(2) || 'N/A'}`);
                            updateStatus('‚ö†Ô∏è Banco salva, mas site usa dados est√°ticos', 'warning');
                        }
                        
                        // Restaurar pre√ßo original
                        window.sqliteManager.updateProduct(produtoTeste.id, {price: precoOriginal});
                        log('üîÑ Pre√ßo original restaurado no banco');
                        
                    } else {
                        log('‚ùå TESTE FALHOU: Dados n√£o foram realmente salvos no banco');
                        updateStatus('‚ùå Salvamento no banco n√£o funciona', 'error');
                    }
                    
                } else {
                    log('‚ùå Falha ao atualizar produto no SQLite');
                    updateStatus('‚ùå Erro ao salvar no banco SQLite', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste de salvamento: ${error.message}`);
                updateStatus('‚ùå Erro durante teste de salvamento', 'error');
            }
        }
        
        function limparLog() {
            if (logContainer) {
                logContainer.innerHTML = '';
            }
            log('üßπ Log limpo');
        }
    </script>
</body>
</html>