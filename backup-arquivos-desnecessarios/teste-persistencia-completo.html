<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Persist√™ncia Completo - Recanto Feliz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .test-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .test-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .test-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .test-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover {
            background: #218838;
        }
        
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .data-preview {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <h1>üî¨ Teste de Persist√™ncia Completo - Recanto Feliz</h1>
    
    <div class="test-container">
        <h2>üìã Cen√°rio de Teste: Persist√™ncia de Dados ap√≥s Limpeza de Cache</h2>
        <p><strong>Objetivo:</strong> Verificar se altera√ß√µes de pre√ßos feitas no admin persistem ap√≥s limpar o cache do navegador.</p>
        
        <div class="test-section test-info">
            <h3>üéØ Plano de Teste</h3>
            <ol>
                <li>Carregar dados originais</li>
                <li>Simular altera√ß√£o de pre√ßo no admin</li>
                <li>Verificar salvamento em m√∫ltiplas fontes</li>
                <li>Simular limpeza de cache (localStorage)</li>
                <li>Recuperar dados e verificar persist√™ncia</li>
                <li>Validar integridade dos dados</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>üöÄ Controles de Teste</h3>
            <button onclick="iniciarTestePersistencia()">‚ñ∂Ô∏è Iniciar Teste Completo</button>
            <button onclick="verificarEstadoAtual()" class="success">üîç Verificar Estado Atual</button>
            <button onclick="simularLimpezaCache()" class="danger">üßπ Simular Limpeza Cache</button>
            <button onclick="restaurarDados()" class="success">‚ôªÔ∏è Recuperar Dados</button>
            <button onclick="limparLog()">üóëÔ∏è Limpar Log</button>
        </div>
    </div>
    
    <div class="results-grid">
        <div class="test-container">
            <h3>üìä Resultados do Teste</h3>
            <div id="resultados-teste" class="log-area">Aguardando in√≠cio do teste...</div>
        </div>
        
        <div class="test-container">
            <h3>üóÉÔ∏è Estado dos Dados</h3>
            <div id="estado-dados" class="data-preview">Carregando...</div>
        </div>
    </div>
    
    <div class="test-container">
        <h3>üìã Compara√ß√£o de Fontes de Dados</h3>
        <div class="results-grid">
            <div>
                <h4>SQLite Database</h4>
                <div id="dados-sqlite" class="data-preview">Carregando...</div>
            </div>
            <div>
                <h4>LocalStorage</h4>
                <div id="dados-localstorage" class="data-preview">Carregando...</div>
            </div>
            <div>
                <h4>SessionStorage</h4>
                <div id="dados-sessionstorage" class="data-preview">Carregando...</div>
            </div>
            <div>
                <h4>IndexedDB</h4>
                <div id="dados-indexeddb" class="data-preview">Carregando...</div>
            </div>
        </div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="js/data-manager.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/persistence-fix.js"></script>
    
    <script>
        let testeLogElement = document.getElementById('resultados-teste');
        let estadoDadosElement = document.getElementById('estado-dados');
        
        // Sistema de log
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è',
                'debug': 'üîß'
            }[type] || '‚ÑπÔ∏è';
            
            const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
            testeLogElement.textContent += logMessage;
            testeLogElement.scrollTop = testeLogElement.scrollHeight;
            console.log(logMessage.trim());
        }
        
        function limparLog() {
            testeLogElement.textContent = 'Log limpo. Aguardando pr√≥ximo teste...\n';
        }
        
        // Fun√ß√µes de verifica√ß√£o de dados
        async function verificarEstadoAtual() {
            log('üîç Verificando estado atual dos dados...', 'info');
            
            try {
                // Verificar todas as fontes de dados
                const estado = {
                    dataManager: window.dataManager ? window.dataManager.getProducts().length : 0,
                    localStorage: localStorage.getItem('produtos_recanto_feliz') ? JSON.parse(localStorage.getItem('produtos_recanto_feliz')).length : 0,
                    sessionStorage: sessionStorage.getItem('produtos_backup') ? JSON.parse(sessionStorage.getItem('produtos_backup')).length : 0,
                    persistenceManager: window.persistenceManager ? 'Dispon√≠vel' : 'Indispon√≠vel'
                };
                
                log(`DataManager: ${estado.dataManager} produtos`, 'info');
                log(`LocalStorage: ${estado.localStorage} produtos`, 'info');
                log(`SessionStorage: ${estado.sessionStorage} produtos`, 'info');
                log(`PersistenceManager: ${estado.persistenceManager}`, 'info');
                
                // Atualizar displays
                atualizarDisplayDados();
                
                log('‚úÖ Verifica√ß√£o conclu√≠da', 'success');
                
            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
            }
        }
        
        function atualizarDisplayDados() {
            // Estado geral
            const produtos = window.dataManager ? window.dataManager.getProducts() : [];
            estadoDadosElement.textContent = `Produtos carregados: ${produtos.length}\n√öltima atualiza√ß√£o: ${new Date().toLocaleString()}`;
            
            // SQLite
            try {
                const sqliteData = window.sqliteManager ? window.sqliteManager.getProducts() : [];
                document.getElementById('dados-sqlite').textContent = 
                    `Produtos: ${sqliteData.length}\n` +
                    (sqliteData.length > 0 ? `Exemplo: ${JSON.stringify(sqliteData[0], null, 2)}` : 'Nenhum produto');
            } catch (e) {
                document.getElementById('dados-sqlite').textContent = 'Erro: ' + e.message;
            }
            
            // LocalStorage
            try {
                const lsData = localStorage.getItem('produtos_recanto_feliz');
                document.getElementById('dados-localstorage').textContent = 
                    lsData ? `Dados encontrados: ${JSON.parse(lsData).length} produtos` : 'Nenhum dado';
            } catch (e) {
                document.getElementById('dados-localstorage').textContent = 'Erro: ' + e.message;
            }
            
            // SessionStorage
            try {
                const ssData = sessionStorage.getItem('produtos_backup');
                document.getElementById('dados-sessionstorage').textContent = 
                    ssData ? `Dados encontrados: ${JSON.parse(ssData).length} produtos` : 'Nenhum dado';
            } catch (e) {
                document.getElementById('dados-sessionstorage').textContent = 'Erro: ' + e.message;
            }
            
            // IndexedDB (simulado)
            document.getElementById('dados-indexeddb').textContent = 'Verifica√ß√£o IndexedDB em desenvolvimento';
        }
        
        async function iniciarTestePersistencia() {
            log('üöÄ Iniciando teste completo de persist√™ncia...', 'info');
            
            try {
                // Passo 1: Verificar estado inicial
                log('üìã Passo 1: Verificando estado inicial', 'info');
                await verificarEstadoAtual();
                
                // Passo 2: Simular altera√ß√£o de pre√ßo
                log('üí∞ Passo 2: Simulando altera√ß√£o de pre√ßos', 'info');
                await simularAlteracaoPreco();
                
                // Passo 3: For√ßar persist√™ncia
                log('üíæ Passo 3: For√ßando persist√™ncia de dados', 'info');
                await forcarPersistencia();
                
                // Passo 4: Verificar dados salvos
                log('üîç Passo 4: Verificando dados ap√≥s salvamento', 'info');
                await verificarEstadoAtual();
                
                // Passo 5: Simular limpeza de cache
                log('üßπ Passo 5: Simulando limpeza de cache', 'warning');
                simularLimpezaCache();
                
                // Passo 6: Tentar recuperar dados
                log('‚ôªÔ∏è Passo 6: Tentando recuperar dados', 'info');
                await restaurarDados();
                
                // Passo 7: Verificar resultado final
                log('üèÅ Passo 7: Verificando resultado final', 'info');
                await verificarEstadoAtual();
                
                log('‚úÖ Teste completo finalizado!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro durante o teste: ${error.message}`, 'error');
            }
        }
        
        async function simularAlteracaoPreco() {
            try {
                const produtos = window.dataManager.getProducts();
                if (produtos.length === 0) {
                    log('‚ö†Ô∏è Nenhum produto encontrado para teste', 'warning');
                    return;
                }
                
                // Selecionar primeiro produto e alterar pre√ßo
                const produto = {...produtos[0]};
                const precoOriginal = produto.preco;
                const novoPreco = precoOriginal + 5.99; // Adicionar R$ 5,99
                
                produto.preco = novoPreco;
                
                log(`üìù Alterando pre√ßo do produto "${produto.nome}"`, 'info');
                log(`üí∞ Pre√ßo original: R$ ${precoOriginal}`, 'info');
                log(`üí∞ Novo pre√ßo: R$ ${novoPreco}`, 'info');
                
                // Simular salvamento no admin
                if (window.dataManager.updateProduct) {
                    window.dataManager.updateProduct(produto.id, produto);
                    log('‚úÖ Produto atualizado no DataManager', 'success');
                } else {
                    log('‚ö†Ô∏è M√©todo updateProduct n√£o encontrado', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro na simula√ß√£o de altera√ß√£o: ${error.message}`, 'error');
            }
        }
        
        async function forcarPersistencia() {
            try {
                if (window.persistenceManager) {
                    const dadosAtuais = {
                        products: window.dataManager.getProducts(),
                        lastUpdate: new Date().toISOString(),
                        source: 'teste_persistencia'
                    };
                    
                    window.persistenceManager.savePersistentData(dadosAtuais);
                    log('‚úÖ Dados salvos com PersistenceManager', 'success');
                } else {
                    log('‚ö†Ô∏è PersistenceManager n√£o dispon√≠vel', 'warning');
                }
                
                // Backup manual adicional
                const produtos = window.dataManager.getProducts();
                localStorage.setItem('teste_backup_manual', JSON.stringify(produtos));
                log('‚úÖ Backup manual criado', 'success');
                
            } catch (error) {
                log(`‚ùå Erro ao for√ßar persist√™ncia: ${error.message}`, 'error');
            }
        }
        
        function simularLimpezaCache() {
            try {
                log('üßπ Simulando limpeza de cache...', 'warning');
                
                // Limpar localStorage (exceto backups de teste)
                const backup = localStorage.getItem('teste_backup_manual');
                const persistentData = localStorage.getItem('recanto_feliz_persistent_data');
                
                localStorage.clear();
                
                // Restaurar apenas dados persistentes
                if (persistentData) {
                    localStorage.setItem('recanto_feliz_persistent_data', persistentData);
                    log('üíæ Dados persistentes preservados', 'info');
                }
                
                if (backup) {
                    localStorage.setItem('teste_backup_manual', backup);
                    log('üíæ Backup de teste preservado', 'info');
                }
                
                // Limpar sessionStorage
                sessionStorage.clear();
                
                log('‚úÖ Cache simulado como limpo', 'success');
                
            } catch (error) {
                log(`‚ùå Erro na simula√ß√£o de limpeza: ${error.message}`, 'error');
            }
        }
        
        async function restaurarDados() {
            try {
                log('‚ôªÔ∏è Tentando recuperar dados...', 'info');
                
                // Tentar usar o sistema de persist√™ncia
                if (window.persistenceManager) {
                    const dadosRecuperados = window.persistenceManager.loadPersistentData();
                    if (dadosRecuperados && dadosRecuperados.products) {
                        log(`‚úÖ Recuperados ${dadosRecuperados.products.length} produtos via PersistenceManager`, 'success');
                        
                        // Restaurar no DataManager
                        if (window.dataManager && window.dataManager.setProducts) {
                            window.dataManager.setProducts(dadosRecuperados.products);
                            log('‚úÖ Dados restaurados no DataManager', 'success');
                        }
                    } else {
                        log('‚ö†Ô∏è Nenhum dado persistente encontrado', 'warning');
                    }
                } else {
                    log('‚ö†Ô∏è PersistenceManager n√£o dispon√≠vel para recupera√ß√£o', 'warning');
                }
                
                // Verificar backup manual
                const backupManual = localStorage.getItem('teste_backup_manual');
                if (backupManual) {
                    const produtosBackup = JSON.parse(backupManual);
                    log(`‚úÖ Backup manual encontrado: ${produtosBackup.length} produtos`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Erro na recupera√ß√£o: ${error.message}`, 'error');
            }
        }
        
        // Inicializa√ß√£o
        window.addEventListener('load', async () => {
            log('üèÅ Sistema de teste carregado', 'info');
            await verificarEstadoAtual();
        });
        
        // Atualizar displays periodicamente
        setInterval(atualizarDisplayDados, 5000);
    </script>
</body>
</html>
