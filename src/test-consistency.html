<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Consist√™ncia de Dados</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">Teste de Consist√™ncia de Fonte de Dados</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4 text-blue-600">üìÑ Arquivo produtos.json</h2>
                <div id="json-data"></div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4 text-green-600">üíæ localStorage Cache</h2>
                <div id="cache-data"></div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-bold mb-4 text-purple-600">üîß DataManager</h2>
            <div id="datamanager-data"></div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4">üîç Resultado da Verifica√ß√£o</h2>
            <div id="verification-result"></div>
            <div class="mt-4 space-x-4">
                <button onclick="runVerification()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Verificar Consist√™ncia
                </button>
                <button onclick="forceSync()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    For√ßar Sincroniza√ß√£o
                </button>
                <a href="index.html" target="_blank" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 inline-block">
                    Testar Index
                </a>
                <a href="admin.html" target="_blank" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 inline-block">
                    Testar Admin
                </a>
            </div>
        </div>
    </div>

    <script src="js/unified-data-source.js"></script>
    <script src="js/data-manager.js"></script>
    <script>
        async function loadData() {
            // Carregar dados do JSON
            try {
                const response = await fetch('data/produtos.json', { cache: 'no-store' });
                const jsonData = await response.json();
                
                let jsonHtml = `<p class="mb-2"><strong>Produtos:</strong> ${jsonData.products.length}</p>`;
                jsonHtml += '<h3 class="font-bold mb-2">Pre√ßos:</h3><ul class="text-sm space-y-1">';
                jsonData.products.forEach(p => {
                    jsonHtml += `<li>${p.name}: <span class="font-bold text-green-600">R$ ${p.price}</span></li>`;
                });
                jsonHtml += '</ul>';
                
                document.getElementById('json-data').innerHTML = jsonHtml;
            } catch (error) {
                document.getElementById('json-data').innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
            
            // Carregar dados do cache
            const cacheData = localStorage.getItem('granjaRecantoFelizData');
            if (cacheData) {
                try {
                    const parsed = JSON.parse(cacheData);
                    let cacheHtml = `<p class="mb-2"><strong>Produtos:</strong> ${parsed.products?.length || 0}</p>`;
                    cacheHtml += `<p class="mb-2"><strong>√öltima atualiza√ß√£o:</strong> ${new Date(parsed.lastUpdate).toLocaleString()}</p>`;
                    cacheHtml += `<p class="mb-2"><strong>Fonte:</strong> ${parsed.syncedFromServer ? 'Servidor' : 'Local'}</p>`;
                    
                    if (parsed.products && parsed.products.length > 0) {
                        cacheHtml += '<h3 class="font-bold mb-2">Pre√ßos:</h3><ul class="text-sm space-y-1">';
                        parsed.products.forEach(p => {
                            cacheHtml += `<li>${p.name}: <span class="font-bold text-green-600">R$ ${p.price}</span></li>`;
                        });
                        cacheHtml += '</ul>';
                    }
                    
                    document.getElementById('cache-data').innerHTML = cacheHtml;
                } catch (error) {
                    document.getElementById('cache-data').innerHTML = `<p class="text-red-500">Cache corrompido: ${error.message}</p>`;
                }
            } else {
                document.getElementById('cache-data').innerHTML = '<p class="text-yellow-500">Cache vazio</p>';
            }
            
            // Carregar dados do DataManager
            try {
                if (!window.dataManager) {
                    window.dataManager = new DataManager();
                }
                
                const products = await window.dataManager.getProducts();
                let dmHtml = `<p class="mb-2"><strong>Produtos:</strong> ${products.length}</p>`;
                
                if (products.length > 0) {
                    dmHtml += '<h3 class="font-bold mb-2">Pre√ßos:</h3><ul class="text-sm space-y-1">';
                    products.forEach(p => {
                        dmHtml += `<li>${p.name}: <span class="font-bold text-green-600">R$ ${p.price}</span></li>`;
                    });
                    dmHtml += '</ul>';
                }
                
                document.getElementById('datamanager-data').innerHTML = dmHtml;
            } catch (error) {
                document.getElementById('datamanager-data').innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        }
        
        async function runVerification() {
            const resultDiv = document.getElementById('verification-result');
            resultDiv.innerHTML = '<p>üîÑ Verificando...</p>';
            
            try {
                const response = await fetch('data/produtos.json', { cache: 'no-store' });
                const jsonData = await response.json();
                const cacheData = localStorage.getItem('granjaRecantoFelizData');
                
                if (!window.dataManager) {
                    window.dataManager = new DataManager();
                }
                const dmProducts = await window.dataManager.getProducts();
                
                let consistent = true;
                let issues = [];
                
                // Verificar JSON vs Cache
                if (cacheData) {
                    const parsed = JSON.parse(cacheData);
                    if (parsed.products && parsed.products.length > 0) {
                        const jsonPrice = jsonData.products[0].price;
                        const cachePrice = parsed.products[0].price;
                        
                        if (jsonPrice !== cachePrice) {
                            consistent = false;
                            issues.push(`Pre√ßo inconsistente: JSON (R$ ${jsonPrice}) vs Cache (R$ ${cachePrice})`);
                        }
                    }
                }
                
                // Verificar JSON vs DataManager
                if (dmProducts.length > 0) {
                    const jsonPrice = jsonData.products[0].price;
                    const dmPrice = dmProducts[0].price;
                    
                    if (jsonPrice !== dmPrice) {
                        consistent = false;
                        issues.push(`Pre√ßo inconsistente: JSON (R$ ${jsonPrice}) vs DataManager (R$ ${dmPrice})`);
                    }
                }
                
                if (consistent) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                            <strong>‚úÖ Dados consistentes!</strong>
                            <p>Todas as fontes t√™m os mesmos valores.</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <strong>‚ùå Inconsist√™ncias detectadas:</strong>
                            <ul class="mt-2 list-disc list-inside">
                                ${issues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">Erro na verifica√ß√£o: ${error.message}</p>`;
            }
        }
        
        async function forceSync() {
            const resultDiv = document.getElementById('verification-result');
            resultDiv.innerHTML = '<p>üîÑ For√ßando sincroniza√ß√£o...</p>';
            
            try {
                // Limpar cache
                localStorage.removeItem('granjaRecantoFelizData');
                
                // Recarregar dados
                await loadData();
                
                resultDiv.innerHTML = `
                    <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">
                        <strong>üîÑ Sincroniza√ß√£o for√ßada!</strong>
                        <p>Cache limpo e dados recarregados.</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">Erro na sincroniza√ß√£o: ${error.message}</p>`;
            }
        }
        
        // Carregar dados quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
