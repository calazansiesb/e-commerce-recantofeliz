<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de PersistÃªncia Completo - Recanto Feliz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .test-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .test-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .test-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .test-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover {
            background: #218838;
        }
        
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .data-preview {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¬ Teste de PersistÃªncia Completo - Recanto Feliz</h1>
    
    <div class="test-container">
        <h2>ğŸ“‹ CenÃ¡rio de Teste: PersistÃªncia de Dados apÃ³s Limpeza de Cache</h2>
        <p><strong>Objetivo:</strong> Verificar se alteraÃ§Ãµes de preÃ§os feitas no admin persistem apÃ³s limpar o cache do navegador.</p>
        
        <div class="test-section test-info">
            <h3>ğŸ¯ Plano de Teste</h3>
            <ol>
                <li>Carregar dados originais</li>
                <li>Simular alteraÃ§Ã£o de preÃ§o no admin</li>
                <li>Verificar salvamento em mÃºltiplas fontes</li>
                <li>Simular limpeza de cache (localStorage)</li>
                <li>Recuperar dados e verificar persistÃªncia</li>
                <li>Validar integridade dos dados</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>ğŸš€ Controles de Teste</h3>
            <button onclick="iniciarTestePersistencia()">â–¶ï¸ Iniciar Teste Completo</button>
            <button onclick="verificarEstadoAtual()" class="success">ğŸ” Verificar Estado Atual</button>
            <button onclick="simularLimpezaCache()" class="danger">ğŸ§¹ Simular Limpeza Cache</button>
            <button onclick="restaurarDados()" class="success">â™»ï¸ Recuperar Dados</button>
            <button onclick="limparLog()">ğŸ—‘ï¸ Limpar Log</button>
        </div>
    </div>
    
    <div class="results-grid">
        <div class="test-container">
            <h3>ğŸ“Š Resultados do Teste</h3>
            <div id="resultados-teste" class="log-area">Aguardando inÃ­cio do teste...</div>
        </div>
        
        <div class="test-container">
            <h3>ğŸ—ƒï¸ Estado dos Dados</h3>
            <div id="estado-dados" class="data-preview">Carregando...</div>
        </div>
    </div>
    
    <div class="test-container">
        <h3>ğŸ“‹ ComparaÃ§Ã£o de Fontes de Dados</h3>
        <div class="results-grid">
            <div>
                <h4>SQLite Database</h4>
                <div id="dados-sqlite" class="data-preview">Carregando...</div>
            </div>
            <div>
                <h4>LocalStorage</h4>
                <div id="dados-localstorage" class="data-preview">Carregando...</div>
            </div>
            <div>
                <h4>SessionStorage</h4>
                <div id="dados-sessionstorage" class="data-preview">Carregando...</div>
            </div>
            <div>
                <h4>IndexedDB</h4>
                <div id="dados-indexeddb" class="data-preview">Carregando...</div>
            </div>
        </div>
    </div>

    <!-- Scripts necessÃ¡rios -->
    <script src="js/data-manager.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/persistence-fix.js"></script>
    
    <script>
        let testeLogElement = document.getElementById('resultados-teste');
        let estadoDadosElement = document.getElementById('estado-dados');
        
        // Sistema de log
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸',
                'debug': 'ğŸ”§'
            }[type] || 'â„¹ï¸';
            
            const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
            testeLogElement.textContent += logMessage;
            testeLogElement.scrollTop = testeLogElement.scrollHeight;
            console.log(logMessage.trim());
        }
        
        function limparLog() {
            testeLogElement.textContent = 'Log limpo. Aguardando prÃ³ximo teste...\n';
        }
        
        // FunÃ§Ãµes de verificaÃ§Ã£o de dados
        async function verificarEstadoAtual() {
            log('ğŸ” Verificando estado atual dos dados...', 'info');
            
            try {
                // Verificar todas as fontes de dados
                const estado = {
                    dataManager: window.dataManager ? window.dataManager.getProducts().length : 0,
                    localStorage: localStorage.getItem('produtos_recanto_feliz') ? JSON.parse(localStorage.getItem('produtos_recanto_feliz')).length : 0,
                    sessionStorage: sessionStorage.getItem('produtos_backup') ? JSON.parse(sessionStorage.getItem('produtos_backup')).length : 0,
                    persistenceManager: window.persistenceManager ? 'DisponÃ­vel' : 'IndisponÃ­vel'
                };
                
                log(`DataManager: ${estado.dataManager} produtos`, 'info');
                log(`LocalStorage: ${estado.localStorage} produtos`, 'info');
                log(`SessionStorage: ${estado.sessionStorage} produtos`, 'info');
                log(`PersistenceManager: ${estado.persistenceManager}`, 'info');
                
                // Atualizar displays
                atualizarDisplayDados();
                
                log('âœ… VerificaÃ§Ã£o concluÃ­da', 'success');
                
            } catch (error) {
                log(`âŒ Erro na verificaÃ§Ã£o: ${error.message}`, 'error');
            }
        }
        
        function atualizarDisplayDados() {
            // Estado geral
            const produtos = window.dataManager ? window.dataManager.getProducts() : [];
            estadoDadosElement.textContent = `Produtos carregados: ${produtos.length}\nÃšltima atualizaÃ§Ã£o: ${new Date().toLocaleString()}`;
            
            // SQLite
            try {
                const sqliteData = window.sqliteManager ? window.sqliteManager.getProducts() : [];
                document.getElementById('dados-sqlite').textContent = 
                    `Produtos: ${sqliteData.length}\n` +
                    (sqliteData.length > 0 ? `Exemplo: ${JSON.stringify(sqliteData[0], null, 2)}` : 'Nenhum produto');
            } catch (e) {
                document.getElementById('dados-sqlite').textContent = 'Erro: ' + e.message;
            }
            
            // LocalStorage
            try {
                const lsData = localStorage.getItem('produtos_recanto_feliz');
                document.getElementById('dados-localstorage').textContent = 
                    lsData ? `Dados encontrados: ${JSON.parse(lsData).length} produtos` : 'Nenhum dado';
            } catch (e) {
                document.getElementById('dados-localstorage').textContent = 'Erro: ' + e.message;
            }
            
            // SessionStorage
            try {
                const ssData = sessionStorage.getItem('produtos_backup');
                document.getElementById('dados-sessionstorage').textContent = 
                    ssData ? `Dados encontrados: ${JSON.parse(ssData).length} produtos` : 'Nenhum dado';
            } catch (e) {
                document.getElementById('dados-sessionstorage').textContent = 'Erro: ' + e.message;
            }
            
            // IndexedDB (simulado)
            document.getElementById('dados-indexeddb').textContent = 'VerificaÃ§Ã£o IndexedDB em desenvolvimento';
        }
        
        async function iniciarTestePersistencia() {
            log('ğŸš€ Iniciando teste completo de persistÃªncia...', 'info');
            
            try {
                // Passo 1: Verificar estado inicial
                log('ğŸ“‹ Passo 1: Verificando estado inicial', 'info');
                await verificarEstadoAtual();
                
                // Passo 2: Simular alteraÃ§Ã£o de preÃ§o
                log('ğŸ’° Passo 2: Simulando alteraÃ§Ã£o de preÃ§os', 'info');
                await simularAlteracaoPreco();
                
                // Passo 3: ForÃ§ar persistÃªncia
                log('ğŸ’¾ Passo 3: ForÃ§ando persistÃªncia de dados', 'info');
                await forcarPersistencia();
                
                // Passo 4: Verificar dados salvos
                log('ğŸ” Passo 4: Verificando dados apÃ³s salvamento', 'info');
                await verificarEstadoAtual();
                
                // Passo 5: Simular limpeza de cache
                log('ğŸ§¹ Passo 5: Simulando limpeza de cache', 'warning');
                simularLimpezaCache();
                
                // Passo 6: Tentar recuperar dados
                log('â™»ï¸ Passo 6: Tentando recuperar dados', 'info');
                await restaurarDados();
                
                // Passo 7: Verificar resultado final
                log('ğŸ Passo 7: Verificando resultado final', 'info');
                await verificarEstadoAtual();
                
                log('âœ… Teste completo finalizado!', 'success');
                
            } catch (error) {
                log(`âŒ Erro durante o teste: ${error.message}`, 'error');
            }
        }
        
        async function simularAlteracaoPreco() {
            try {
                const produtos = window.dataManager.getProducts();
                if (produtos.length === 0) {
                    log('âš ï¸ Nenhum produto encontrado para teste', 'warning');
                    return;
                }
                
                // Selecionar primeiro produto e alterar preÃ§o
                const produto = {...produtos[0]};
                const precoOriginal = produto.preco;
                const novoPreco = precoOriginal + 5.99; // Adicionar R$ 5,99
                
                produto.preco = novoPreco;
                
                log(`ğŸ“ Alterando preÃ§o do produto "${produto.nome}"`, 'info');
                log(`ğŸ’° PreÃ§o original: R$ ${precoOriginal}`, 'info');
                log(`ğŸ’° Novo preÃ§o: R$ ${novoPreco}`, 'info');
                
                // Simular salvamento no admin
                if (window.dataManager.updateProduct) {
                    window.dataManager.updateProduct(produto.id, produto);
                    log('âœ… Produto atualizado no DataManager', 'success');
                } else {
                    log('âš ï¸ MÃ©todo updateProduct nÃ£o encontrado', 'warning');
                }
                
            } catch (error) {
                log(`âŒ Erro na simulaÃ§Ã£o de alteraÃ§Ã£o: ${error.message}`, 'error');
            }
        }
        
        async function forcarPersistencia() {
            try {
                if (window.persistenceManager) {
                    const dadosAtuais = {
                        products: window.dataManager.getProducts(),
                        lastUpdate: new Date().toISOString(),
                        source: 'teste_persistencia'
                    };
                    
                    window.persistenceManager.savePersistentData(dadosAtuais);
                    log('âœ… Dados salvos com PersistenceManager', 'success');
                } else {
                    log('âš ï¸ PersistenceManager nÃ£o disponÃ­vel', 'warning');
                }
                
                // Backup manual adicional
                const produtos = window.dataManager.getProducts();
                localStorage.setItem('teste_backup_manual', JSON.stringify(produtos));
                log('âœ… Backup manual criado', 'success');
                
            } catch (error) {
                log(`âŒ Erro ao forÃ§ar persistÃªncia: ${error.message}`, 'error');
            }
        }
        
        function simularLimpezaCache() {
            try {
                log('ğŸ§¹ Simulando limpeza de cache...', 'warning');
                
                // Limpar localStorage (exceto backups de teste)
                const backup = localStorage.getItem('teste_backup_manual');
                const persistentData = localStorage.getItem('recanto_feliz_persistent_data');
                
                localStorage.clear();
                
                // Restaurar apenas dados persistentes
                if (persistentData) {
                    localStorage.setItem('recanto_feliz_persistent_data', persistentData);
                    log('ğŸ’¾ Dados persistentes preservados', 'info');
                }
                
                if (backup) {
                    localStorage.setItem('teste_backup_manual', backup);
                    log('ğŸ’¾ Backup de teste preservado', 'info');
                }
                
                // Limpar sessionStorage
                sessionStorage.clear();
                
                log('âœ… Cache simulado como limpo', 'success');
                
            } catch (error) {
                log(`âŒ Erro na simulaÃ§Ã£o de limpeza: ${error.message}`, 'error');
            }
        }
        
        async function restaurarDados() {
            try {
                log('â™»ï¸ Tentando recuperar dados...', 'info');
                
                // Tentar usar o sistema de persistÃªncia
                if (window.persistenceManager) {
                    const dadosRecuperados = window.persistenceManager.loadPersistentData();
                    if (dadosRecuperados && dadosRecuperados.products) {
                        log(`âœ… Recuperados ${dadosRecuperados.products.length} produtos via PersistenceManager`, 'success');
                        
                        // Restaurar no DataManager
                        if (window.dataManager && window.dataManager.setProducts) {
                            window.dataManager.setProducts(dadosRecuperados.products);
                            log('âœ… Dados restaurados no DataManager', 'success');
                        }
                    } else {
                        log('âš ï¸ Nenhum dado persistente encontrado', 'warning');
                    }
                } else {
                    log('âš ï¸ PersistenceManager nÃ£o disponÃ­vel para recuperaÃ§Ã£o', 'warning');
                }
                
                // Verificar backup manual
                const backupManual = localStorage.getItem('teste_backup_manual');
                if (backupManual) {
                    const produtosBackup = JSON.parse(backupManual);
                    log(`âœ… Backup manual encontrado: ${produtosBackup.length} produtos`, 'success');
                }
                
            } catch (error) {
                log(`âŒ Erro na recuperaÃ§Ã£o: ${error.message}`, 'error');
            }
        }
        
        // InicializaÃ§Ã£o
        window.addEventListener('load', async () => {
            log('ğŸ Sistema de teste carregado', 'info');
            await verificarEstadoAtual();
        });
        
        // Atualizar displays periodicamente
        setInterval(atualizarDisplayDados, 5000);
    </script>
</body>
</html>
