<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifica√ß√£o de Banco de Dados - Granja Recanto Feliz</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #45a049; }
        .button.blue { background: #2196F3; }
        .button.blue:hover { background: #0b7dda; }
        .button.red { background: #f44336; }
        .button.red:hover { background: #da190b; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; border-left: 4px solid; }
        .status.success { background: #d4edda; border-color: #28a745; color: #155724; }
        .status.error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .status.warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .status.info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        .product-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .product-table th, .product-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .product-table th { background-color: #f8f9fa; font-weight: bold; }
        .product-table tr:hover { background-color: #f8f9fa; }
        .highlight { background-color: #fff3cd; font-weight: bold; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; border: 1px solid #e9ecef; }
        .tabs { display: flex; border-bottom: 2px solid #e9ecef; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 16px; color: #6c757d; }
        .tab.active { color: #495057; border-bottom: 2px solid #007bff; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .search-box { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è Verifica√ß√£o de Banco de Dados</h1>
        
        <div class="section">
            <h2>üìä Status do Sistema</h2>
            <div id="system-status">Verificando sistema...</div>
        </div>

        <div class="section">
            <h2>üîß Controles</h2>
            <button class="button" onclick="initializeDatabase()">üöÄ Inicializar Banco</button>
            <button class="button blue" onclick="verifyAllData()">üîç Verificar Dados</button>
            <button class="button" onclick="forceReseed()">üå± Reinserir Dados Padr√£o</button>
            <button class="button red" onclick="resetDatabase()">üóëÔ∏è Resetar Banco</button>
            <button class="button" onclick="exportData()">üì• Exportar Dados</button>
            <button class="button blue" onclick="debugDatabase()">üîß Debug Completo</button>
        </div>

        <div class="section">
            <div class="tabs">
                <button class="tab active" onclick="showTab('products')">üì¶ Produtos</button>
                <button class="tab" onclick="showTab('orders')">üõí Pedidos</button>
                <button class="tab" onclick="showTab('stats')">üìä Estat√≠sticas</button>
                <button class="tab" onclick="showTab('logs')">üìã Logs</button>
            </div>

            <div id="tab-products" class="tab-content active">
                <h3>üì¶ Gest√£o de Produtos</h3>
                <input type="text" class="search-box" id="product-search" placeholder="Pesquisar produtos..." onkeyup="filterProducts()">
                <div id="products-content">
                    <p>Clique em "Verificar Dados" para carregar produtos...</p>
                </div>
            </div>

            <div id="tab-orders" class="tab-content">
                <h3>üõí Gest√£o de Pedidos</h3>
                <div id="orders-content">
                    <p>Clique em "Verificar Dados" para carregar pedidos...</p>
                </div>
            </div>

            <div id="tab-stats" class="tab-content">
                <h3>üìä Estat√≠sticas do Sistema</h3>
                <div id="stats-content">
                    <p>Clique em "Verificar Dados" para carregar estat√≠sticas...</p>
                </div>
            </div>

            <div id="tab-logs" class="tab-content">
                <h3>üìã Logs do Sistema</h3>
                <div id="logs-content">
                    <div id="console-logs" style="background: #1e1e1e; color: #fff; padding: 15px; border-radius: 4px; height: 300px; overflow-y: auto; font-family: monospace;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts necess√°rios -->
    <!-- SQL.js desativado: <script src="https://sql.js.org/dist/sql-wasm.js"></script> -->
    <script src="js/database-manager.js"></script>
    
    <script>
        let dbManager = null;
        let allProducts = [];

        // Interceptar console para mostrar logs
        const originalLog = console.log;
        const originalError = console.error;
        const logsContainer = document.getElementById('console-logs');

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#feca57' : '#51cf66';
            div.innerHTML = `[${timestamp}] ${message}`;
            logsContainer.appendChild(div);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        // Gerenciamento de abas
        function showTab(tabName) {
            // Remover active de todas as abas
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Inicializar banco de dados
        async function initializeDatabase() {
            updateStatus('Inicializando banco de dados...', 'info');
            
            try {
                dbManager = new DatabaseManager();
                const success = await dbManager.init();
                
                if (success) {
                    updateStatus('‚úÖ Banco de dados inicializado com sucesso!', 'success');
                    await verifyAllData();
                } else {
                    updateStatus('‚ùå Falha ao inicializar banco de dados', 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå Erro: ${error.message}`, 'error');
                console.error('Erro na inicializa√ß√£o:', error);
            }
        }

        // Verificar todos os dados
        async function verifyAllData() {
            if (!dbManager) {
                updateStatus('‚ö†Ô∏è Banco n√£o inicializado. Clique em "Inicializar Banco" primeiro.', 'warning');
                return;
            }

            updateStatus('Verificando dados...', 'info');

            try {
                // Carregar produtos
                await loadProducts();
                
                // Carregar estat√≠sticas
                await loadStats();
                
                updateStatus('‚úÖ Dados verificados com sucesso!', 'success');
            } catch (error) {
                updateStatus(`‚ùå Erro ao verificar dados: ${error.message}`, 'error');
            }
        }

        // Carregar produtos
        async function loadProducts() {
            try {
                allProducts = dbManager.getProducts();
                displayProducts(allProducts);
                console.log(`üì¶ ${allProducts.length} produtos carregados do banco`);
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                document.getElementById('products-content').innerHTML = `
                    <div class="status error">
                        ‚ùå Erro ao carregar produtos: ${error.message}
                    </div>
                `;
            }
        }

        // Exibir produtos
        function displayProducts(products) {
            const container = document.getElementById('products-content');
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="status warning">
                        ‚ö†Ô∏è Nenhum produto encontrado no banco de dados
                    </div>
                `;
                return;
            }

            let html = `
                <div class="status success">
                    ‚úÖ ${products.length} produtos encontrados
                </div>
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Pre√ßo</th>
                            <th>Estoque</th>
                            <th>Status</th>
                            <th>Criado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            products.forEach(product => {
                const statusClass = product.active ? 'success' : 'error';
                const statusText = product.active ? 'Ativo' : 'Inativo';
                
                html += `
                    <tr class="${product.active ? '' : 'highlight'}">
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>R$ ${parseFloat(product.price).toFixed(2)}</td>
                        <td>${product.stock}</td>
                        <td><span class="status ${statusClass}" style="padding: 2px 6px; font-size: 12px;">${statusText}</span></td>
                        <td>${new Date(product.created_at).toLocaleDateString('pt-BR')}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Filtrar produtos
        function filterProducts() {
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            const filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            displayProducts(filteredProducts);
        }

        // Carregar estat√≠sticas
        async function loadStats() {
            try {
                const stats = dbManager.getStats();
                
                document.getElementById('stats-content').innerHTML = `
                    <div class="status info">
                        üìä Estat√≠sticas atualizadas em ${new Date().toLocaleString('pt-BR')}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div class="status success">
                            <strong>üì¶ Produtos Ativos</strong><br>
                            ${stats.products || 0}
                        </div>
                        <div class="status info">
                            <strong>üõí Total de Pedidos</strong><br>
                            ${stats.orders || 0}
                        </div>
                        <div class="status warning">
                            <strong>üí∞ Valor do Estoque</strong><br>
                            R$ ${(stats.stockValue || 0).toFixed(2)}
                        </div>
                    </div>
                    
                    <h4>üìã Detalhes T√©cnicos</h4>
                    <pre>${JSON.stringify(stats, null, 2)}</pre>
                `;
            } catch (error) {
                document.getElementById('stats-content').innerHTML = `
                    <div class="status error">
                        ‚ùå Erro ao carregar estat√≠sticas: ${error.message}
                    </div>
                `;
            }
        }

        // For√ßar reinser√ß√£o de dados padr√£o
        function forceReseed() {
            if (!dbManager) {
                updateStatus('‚ö†Ô∏è Banco n√£o inicializado', 'warning');
                return;
            }

            if (!confirm('‚ö†Ô∏è Isso ir√° apagar todos os produtos atuais e inserir os dados padr√£o. Continuar?')) {
                return;
            }

            updateStatus('For√ßando reinser√ß√£o de dados padr√£o...', 'info');
            
            try {
                const success = dbManager.forceReseedData();
                
                if (success) {
                    updateStatus('‚úÖ Dados padr√£o reinseridos com sucesso!', 'success');
                    verifyAllData();
                } else {
                    updateStatus('‚ùå Falha ao reinserir dados padr√£o', 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Debug completo do banco
        function debugDatabase() {
            if (!dbManager) {
                updateStatus('‚ö†Ô∏è Banco n√£o inicializado', 'warning');
                return;
            }

            updateStatus('Executando debug completo...', 'info');
            
            try {
                console.log('üîß === DEBUG COMPLETO DO BANCO ===');
                
                // 1. Verificar inicializa√ß√£o
                console.log('‚úÖ Banco inicializado:', dbManager.isInitialized);
                console.log('‚úÖ Inst√¢ncia DB:', !!dbManager.db);
                
                // 2. Executar consultas diretas
                const tables = dbManager.db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                console.log('üìã Tabelas no banco:', tables);
                
                const productsCount = dbManager.db.exec("SELECT COUNT(*) as count FROM products");
                console.log('üìä Contagem de produtos:', productsCount);
                
                const allProducts = dbManager.db.exec("SELECT * FROM products");
                console.log('üì¶ Todos os produtos:', allProducts);
                
                // 3. Verificar localStorage
                const localStorage_db = localStorage.getItem('granjaRecantoFeliz_db');
                console.log('üíæ localStorage DB existe:', !!localStorage_db);
                console.log('üíæ Tamanho do localStorage DB:', localStorage_db ? localStorage_db.length : 0);
                
                updateStatus('‚úÖ Debug completo executado! Verifique o console.', 'success');
                
            } catch (error) {
                updateStatus(`‚ùå Erro no debug: ${error.message}`, 'error');
                console.error('‚ùå Erro detalhado no debug:', error);
            }
        }

        // Resetar banco
        async function resetDatabase() {
            if (!confirm('‚ö†Ô∏è Isso ir√° apagar TODOS os dados do banco. Tem certeza?')) {
                return;
            }

            updateStatus('Resetando banco de dados...', 'warning');
            
            try {
                localStorage.removeItem('granjaRecantoFeliz_db');
                dbManager = null;
                
                // Limpar conte√∫do
                document.getElementById('products-content').innerHTML = '<p>Banco resetado. Clique em "Inicializar Banco" para come√ßar.</p>';
                document.getElementById('stats-content').innerHTML = '<p>Banco resetado. Clique em "Inicializar Banco" para come√ßar.</p>';
                
                updateStatus('‚úÖ Banco de dados resetado com sucesso!', 'success');
            } catch (error) {
                updateStatus(`‚ùå Erro ao resetar banco: ${error.message}`, 'error');
            }
        }

        // Exportar dados
        function exportData() {
            if (!dbManager) {
                updateStatus('‚ö†Ô∏è Banco n√£o inicializado', 'warning');
                return;
            }

            try {
                const data = {
                    products: dbManager.getProducts(),
                    stats: dbManager.getStats(),
                    exportDate: new Date().toISOString(),
                    version: '2.0.0'
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `granja-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                updateStatus('‚úÖ Dados exportados com sucesso!', 'success');
            } catch (error) {
                updateStatus(`‚ùå Erro ao exportar: ${error.message}`, 'error');
            }
        }

        // Atualizar status
        function updateStatus(message, type) {
            document.getElementById('system-status').innerHTML = `
                <div class="status ${type}">
                    ${message}
                </div>
            `;
        }

        // Inicializa√ß√£o autom√°tica
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('Sistema carregado. Clique em "Inicializar Banco" para come√ßar.', 'info');
            addLog('üöÄ Sistema de verifica√ß√£o carregado');
        });
    </script>
</body>
</html>
