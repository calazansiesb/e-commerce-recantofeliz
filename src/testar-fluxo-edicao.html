<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Fluxo: Edi√ß√£o ‚Üí Banco ‚Üí Site</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .step { border: 2px solid #ddd; margin: 15px 0; padding: 15px; border-radius: 8px; }
        .step.active { border-color: #007bff; background: #f8f9ff; }
        .step.success { border-color: #28a745; background: #f8fff9; }
        .step.error { border-color: #dc3545; background: #fff5f5; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .value-display { font-size: 1.2em; font-weight: bold; color: #dc3545; margin: 10px 0; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; }
        .source { border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; }
        .source.localStorage { background: #e3f2fd; }
        .source.sqlite { background: #f3e5f5; }
        .source.site { background: #e8f5e8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Teste de Fluxo: Edi√ß√£o ‚Üí Banco ‚Üí Site</h1>
        <p>Esta ferramenta testa se as edi√ß√µes feitas no admin s√£o salvas no banco SQLite e refletidas no site principal.</p>
        
        <div class="step" id="step1">
            <h3>üìã Passo 1: Estado Inicial</h3>
            <button onclick="capturarEstadoInicial()">Capturar Estado Inicial</button>
            <div class="log" id="log1"></div>
        </div>
        
        <div class="step" id="step2">
            <h3>‚úèÔ∏è Passo 2: Simular Edi√ß√£o</h3>
            <button onclick="simularEdicao()">Simular Edi√ß√£o de Produto</button>
            <div class="log" id="log2"></div>
        </div>
        
        <div class="step" id="step3">
            <h3>üíæ Passo 3: Verificar Salvamento no Banco</h3>
            <button onclick="verificarBanco()">Verificar se Salvou no SQLite</button>
            <div class="log" id="log3"></div>
        </div>
        
        <div class="step" id="step4">
            <h3>üåê Passo 4: Verificar Reflexo no Site</h3>
            <button onclick="verificarSite()">Verificar se Aparece no Site</button>
            <div class="log" id="log4"></div>
        </div>
        
        <div class="comparison" id="comparison" style="display: none;">
            <div class="source localStorage">
                <h4>üì¶ localStorage</h4>
                <div class="value-display" id="value-localStorage">-</div>
            </div>
            <div class="source sqlite">
                <h4>üóÑÔ∏è SQLite</h4>
                <div class="value-display" id="value-sqlite">-</div>
            </div>
            <div class="source site">
                <h4>üåê Site Principal</h4>
                <div class="value-display" id="value-site">-</div>
            </div>
        </div>
        
        <div class="step" id="resultado" style="display: none;">
            <h3>üéØ Resultado do Teste</h3>
            <div id="resultado-content"></div>
        </div>
        
        <button onclick="executarTesteCompleto()" style="background: #28a745; font-size: 16px; padding: 15px 30px;">
            üöÄ Executar Teste Completo
        </button>
    </div>

    <script src="js/data-manager.js"></script>
    <!-- sqlite-manager disabled: using localStorage + server save flow -->
    <!-- <script src="js/sqlite-manager.js"></script> -->
    
    <script>
        let produtoTeste = null;
        let precoOriginal = null;
        let novoPreco = null;
        
        function log(stepId, message) {
            const logElement = document.getElementById(`log${stepId}`);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[Passo ${stepId}] ${message}`);
        }
        
        function setStepStatus(stepId, status) {
            const step = document.getElementById(`step${stepId}`);
            step.className = `step ${status}`;
        }
        
        async function capturarEstadoInicial() {
            setStepStatus(1, 'active');
            log(1, 'üîç Capturando estado inicial...');
            
            try {
                // Inicializar sistemas se necess√°rio
                if (!window.dataManager) {
                    window.dataManager = new DataManager();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Attempt to initialize SQLite only if the full manager is available
                if (typeof window.initSQLiteManager === 'function' && window.initSQLiteManager !== null && !window.sqliteManager) {
                    try {
                        await window.initSQLiteManager();
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (e) {
                        console.warn('SQLite init skipped or failed:', e);
                    }
                }
                
                // Obter produtos
                const produtos = window.dataManager.getProducts();
                if (produtos.length === 0) {
                    log(1, '‚ùå Nenhum produto encontrado');
                    setStepStatus(1, 'error');
                    return;
                }
                
                // Selecionar primeiro produto para teste
                produtoTeste = {...produtos[0]};
                precoOriginal = produtoTeste.price;
                
                log(1, `‚úÖ Produto selecionado: ${produtoTeste.name}`);
                log(1, `üí∞ Pre√ßo atual: R$ ${precoOriginal.toFixed(2)}`);
                log(1, `üÜî ID: ${produtoTeste.id}`);
                
                setStepStatus(1, 'success');
                
            } catch (error) {
                log(1, `‚ùå Erro: ${error.message}`);
                setStepStatus(1, 'error');
            }
        }
        
        async function simularEdicao() {
            if (!produtoTeste) {
                log(2, '‚ùå Execute o Passo 1 primeiro');
                return;
            }
            
            setStepStatus(2, 'active');
            log(2, '‚úèÔ∏è Simulando edi√ß√£o de produto...');
            
            try {
                // Gerar novo pre√ßo (adicionar 1 centavo para teste)
                novoPreco = precoOriginal + 0.01;
                
                log(2, `üîß Alterando pre√ßo de R$ ${precoOriginal.toFixed(2)} para R$ ${novoPreco.toFixed(2)}`);
                
                // Simular salvamento via DataManager (como faz o admin)
                const produtoEditado = {...produtoTeste, price: novoPreco};
                
                if (window.dataManager.updateProduct) {
                    const sucesso = await window.dataManager.updateProduct(produtoTeste.id, produtoEditado);
                    
                    if (sucesso) {
                        log(2, '‚úÖ Produto atualizado via DataManager');
                        setStepStatus(2, 'success');
                    } else {
                        log(2, '‚ùå Falha ao atualizar via DataManager');
                        setStepStatus(2, 'error');
                    }
                } else {
                    log(2, '‚ùå DataManager.updateProduct n√£o dispon√≠vel');
                    setStepStatus(2, 'error');
                }
                
            } catch (error) {
                log(2, `‚ùå Erro na edi√ß√£o: ${error.message}`);
                setStepStatus(2, 'error');
            }
        }
        
        async function verificarBanco() {
            if (!produtoTeste || !novoPreco) {
                log(3, '‚ùå Execute os passos anteriores primeiro');
                return;
            }
            
            setStepStatus(3, 'active');
            log(3, 'üóÑÔ∏è Verificando se foi salvo no banco SQLite...');
            
            try {
                // Verificar localStorage primeiro
                const dataLS = localStorage.getItem('granjaRecantoFelizData');
                if (dataLS) {
                    const parsed = JSON.parse(dataLS);
                    const produtoLS = parsed.products?.find(p => p.id === produtoTeste.id);
                    
                    if (produtoLS) {
                        log(3, `üì¶ localStorage: R$ ${produtoLS.price.toFixed(2)}`);
                        document.getElementById('value-localStorage').textContent = `R$ ${produtoLS.price.toFixed(2)}`;
                        
                        if (produtoLS.price === novoPreco) {
                            log(3, '‚úÖ localStorage foi atualizado corretamente');
                        } else {
                            log(3, '‚ö†Ô∏è localStorage n√£o reflete a edi√ß√£o');
                        }
                    }
                }
                
                // Verificar SQLite
                if (window.sqliteManager && window.sqliteManager.db) {
                    const produtosSQLite = window.sqliteManager.getProducts();
                    const produtoSQL = produtosSQLite.find(p => p.id === produtoTeste.id);
                    
                    if (produtoSQL) {
                        log(3, `üóÑÔ∏è SQLite: R$ ${produtoSQL.price.toFixed(2)}`);
                        document.getElementById('value-sqlite').textContent = `R$ ${produtoSQL.price.toFixed(2)}`;
                        
                        if (produtoSQL.price === novoPreco) {
                            log(3, '‚úÖ SQLite foi atualizado corretamente');
                            setStepStatus(3, 'success');
                        } else {
                            log(3, '‚ùå SQLite N√ÉO foi atualizado');
                            log(3, `Expected: R$ ${novoPreco.toFixed(2)}, Got: R$ ${produtoSQL.price.toFixed(2)}`);
                            setStepStatus(3, 'error');
                        }
                    } else {
                        log(3, '‚ùå Produto n√£o encontrado no SQLite');
                        setStepStatus(3, 'error');
                    }
                } else {
                    log(3, '‚ùå SQLite n√£o dispon√≠vel');
                    setStepStatus(3, 'error');
                }
                
                document.getElementById('comparison').style.display = 'grid';
                
            } catch (error) {
                log(3, `‚ùå Erro ao verificar banco: ${error.message}`);
                setStepStatus(3, 'error');
            }
        }
        
        async function verificarSite() {
            if (!produtoTeste || !novoPreco) {
                log(4, '‚ùå Execute os passos anteriores primeiro');
                return;
            }
            
            setStepStatus(4, 'active');
            log(4, 'üåê Verificando se aparece no site principal...');
            
            try {
                // Simular carregamento do site (como faz o index.html)
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Obter produtos como o site faria
                const produtosSite = window.dataManager.getProducts();
                const produtoSite = produtosSite.find(p => p.id === produtoTeste.id);
                
                if (produtoSite) {
                    log(4, `üåê Site principal: R$ ${produtoSite.price.toFixed(2)}`);
                    document.getElementById('value-site').textContent = `R$ ${produtoSite.price.toFixed(2)}`;
                    
                    if (produtoSite.price === novoPreco) {
                        log(4, '‚úÖ Site principal reflete a edi√ß√£o');
                        setStepStatus(4, 'success');
                    } else {
                        log(4, '‚ùå Site principal N√ÉO reflete a edi√ß√£o');
                        log(4, `Expected: R$ ${novoPreco.toFixed(2)}, Got: R$ ${produtoSite.price.toFixed(2)}`);
                        setStepStatus(4, 'error');
                    }
                } else {
                    log(4, '‚ùå Produto n√£o encontrado no site');
                    setStepStatus(4, 'error');
                }
                
                // Mostrar resultado final
                mostrarResultado();
                
            } catch (error) {
                log(4, `‚ùå Erro ao verificar site: ${error.message}`);
                setStepStatus(4, 'error');
            }
        }
        
        function mostrarResultado() {
            const resultadoDiv = document.getElementById('resultado');
            const contentDiv = document.getElementById('resultado-content');
            
            const valueLS = document.getElementById('value-localStorage').textContent;
            const valueSQL = document.getElementById('value-sqlite').textContent;
            const valueSite = document.getElementById('value-site').textContent;
            
            let html = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h4>üìä Resumo dos Valores:</h4>
                    <p><strong>Pre√ßo Original:</strong> R$ ${precoOriginal.toFixed(2)}</p>
                    <p><strong>Novo Pre√ßo (Teste):</strong> R$ ${novoPreco.toFixed(2)}</p>
                    <p><strong>localStorage:</strong> ${valueLS}</p>
                    <p><strong>SQLite:</strong> ${valueSQL}</p>
                    <p><strong>Site Principal:</strong> ${valueSite}</p>
                </div>
            `;
            
            // An√°lise do fluxo
            html += `<h4>üîç An√°lise do Fluxo:</h4>`;
            
            if (valueLS === `R$ ${novoPreco.toFixed(2)}` && 
                valueSQL === `R$ ${novoPreco.toFixed(2)}` && 
                valueSite === `R$ ${novoPreco.toFixed(2)}`) {
                html += `<p style="color: #28a745; font-weight: bold;">‚úÖ PERFEITO: Edi√ß√£o ‚Üí localStorage ‚Üí SQLite ‚Üí Site (Fluxo completo funcionando)</p>`;
            } else {
                html += `<p style="color: #dc3545; font-weight: bold;">‚ùå PROBLEMA IDENTIFICADO:</p><ul>`;
                
                if (valueLS !== `R$ ${novoPreco.toFixed(2)}`) {
                    html += `<li>localStorage n√£o foi atualizado (problema no DataManager)</li>`;
                }
                
                if (valueSQL !== `R$ ${novoPreco.toFixed(2)}`) {
                    html += `<li>SQLite n√£o foi atualizado (problema na sincroniza√ß√£o)</li>`;
                }
                
                if (valueSite !== `R$ ${novoPreco.toFixed(2)}`) {
                    html += `<li>Site n√£o reflete mudan√ßas (usando dados est√°ticos ou cache)</li>`;
                }
                
                html += `</ul>`;
            }
            
            // Restaurar valor original
            html += `<button onclick="restaurarValorOriginal()" style="background: #6c757d; margin-top: 15px;">üîÑ Restaurar Valor Original</button>`;
            
            contentDiv.innerHTML = html;
            resultadoDiv.style.display = 'block';
        }
        
        async function restaurarValorOriginal() {
            if (produtoTeste && precoOriginal) {
                try {
                    await window.dataManager.updateProduct(produtoTeste.id, {price: precoOriginal});
                    alert(`‚úÖ Valor restaurado para R$ ${precoOriginal.toFixed(2)}`);
                    location.reload();
                } catch (error) {
                    alert(`‚ùå Erro ao restaurar: ${error.message}`);
                }
            }
        }
        
        async function executarTesteCompleto() {
            await capturarEstadoInicial();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await simularEdicao();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await verificarBanco();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await verificarSite();
        }
    </script>
</body>
</html>